# 网络架构负载均衡

## 前言
负载均衡通常解决方案是四层交换和七层交换的架构处理，这里的四层和七层对应的是网络模型中的传输层和应用层。

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/四层负载均衡和七层负载均衡.png" height="300px" />

## 四层负载均衡
四层负载均衡工作在 OSI 七层模型的第四层（传输层）。四层负载均衡器在网络流量到达时，会根据预设的负载均衡算法（如轮询、最少连接、源 IP 哈希等）来决定将流量转发到哪个后端服务器。它仅查看传入请求的 IP 地址和端口号，不会深入到应用层协议（如 HTTP/HTTPS）。

所以四层负载均衡对数据包只起一个数据转发的作用，无法修改或判断所请求资源的具体类型，也不会干预客户端与服务器之间应用层的通信（如三次握手等）。也就是说**TCP 的连接建立，即三次握手是客户端和服务器直接建立的，负载均衡设备只是起到一个类似路由器的转发动作**。

但在某些部署情况下，为保证服务器回包可以正确返回给负载均衡设备，负载均衡设备在转发报文的同时可能会对报文原来的源地址进行修改。

**四层负载均衡设备不需要和上下游建立连接。相比七层负载均衡设备他的抗负载能力强，性能高。**

### 转接流程
1. 客户端请求
    - 客户端发起一个请求，这个请求包含了目标 IP 地址和端口号。这个请求首先到达四层负载均衡器。
2. 负载均衡决策
    - 四层负载均衡器接收到请求后，根据预设的负载均衡算法（如轮询、最少连接数、源 IP 哈希等）来选择一个后端服务器。这个决策仅基于 IP 地址和端口号，不涉及应用层数据。
3. 请求转发
    - 一旦负载均衡器决定了目标后端服务器，它会将请求转发到该服务器。在这个过程中，负载均衡器可以修改数据包的目标 IP 地址为后端服务器的 IP 地址，同时保持源 IP 地址不变，以确保后端服务器能够将响应返回给负载均衡器。
4. 后端服务器处理
    - 后端服务器接收到请求，处理请求，并生成响应。由于请求经过了负载均衡器，后端服务器可能会将响应发送回负载均衡器，而不是直接返回给客户端。
5. 响应返回
    - 负载均衡器接收到后端服务器的响应后，将响应转发回原始请求的客户端。在这个过程中，负载均衡器会将源 IP 地址修改为自己的 IP 地址，而目标 IP 地址则修改为客户端的 IP 地址。
6. 客户端接收响应
    - 客户端接收到来自负载均衡器的响应，就像这个响应直接来自于请求的服务器一样。对客户端来说，负载均衡器的存在是透明的。
### 应用场景
- 数据库负载均衡：数据库通常使用 TCP 连接，四层负载均衡可以有效地在多个数据库副本之间分配请求。
- VPN 流量分发：VPN 服务通常基于 TCP 或 UDP，四层负载均衡可以帮助分发加密的 VPN 流量到不同的处理服务器。
- 邮件服务：邮件传输协议（如 SMTP、IMAP）基于 TCP，可以通过四层负载均衡来提高邮件服务的可用性和性能。
### 常见的四层负载均衡设备
- LVS (Linux Virtual Server)
  - LVS是一个开源的负载均衡软件，工作在Linux操作系统上。它支持多种负载均衡算法，如轮询、最少连接数等。
- HAProxy
  - HAProxy是一款免费、开源的高性能负载均衡软件，支持TCP和HTTP应用的负载均衡。它广泛应用于提高网站的可用性和性能。
- F5 BIG-IP
  - F5 BIG-IP是一款高性能的硬件负载均衡设备，提供广泛的应用交付服务，包括但不限于四层（传输层）和七层（应用层）的负载均衡。这使得F5 BIG-IP能够根据IP地址和端口号（四层）以及HTTP/HTTPS请求的内容（七层），如URL、HTTP头、Cookie等，进行智能流量分发。
## 七层负载均衡
七层负载均衡工作在OSI模型的应用层，主要基于 HTTP/HTTPS 协议实现请求的分发。它通过分析请求的内容（如URL、HTTP头、Cookie等）来决定如何分配客户端请求到后端服务器。

**七层负载均衡设备的转发流量首先要与客户端、服务器各建立一个 TCP 连接，建立 TCP 连接是需要成本的。所以七层负载均衡设备的负载能力与机器 I/O、CPU 内存相关。一旦连接很多的话（比如百万级别），七层负载均衡设备的抗负载能力就会急剧下降。**

### 转接流程
1. 客户端请求
   - 客户端发起HTTP/HTTPS请求，这个请求首先到达七层负载均衡器。
2. 负载均衡决策
   - 七层负载均衡器接收到请求后，根据预设的负载均衡算法（如基于URL、HTTP头、Cookie等的内容路由、会话保持等）来选择一个后端服务器。这个决策基于应用层数据。
3. 请求转发
   - 一旦负载均衡器决定了目标后端服务器，它会将请求转发到该服务器。在这个过程中，负载均衡器可以修改请求的一些内容，如HTTP头部信息，并与后端服务器建立一个新的HTTP/HTTPS连接。
4. 后端服务器处理
   - 后端服务器接收到请求，处理请求，并生成响应。由于请求经过了负载均衡器，后端服务器可能会将响应发送回负载均衡器，而不是直接返回给客户端。
1. 响应返回
   - 负载均衡器接收到后端服务器的响应后，将响应转发回原始请求的客户端。在这个过程中，负载均衡器可以修改响应的一些内容，如HTTP头部信息。
2. 客户端接收响应
   - 客户端接收到来自负载均衡器的响应，就像这个响应直接来自于请求的服务器一样。对客户端来说，负载均衡器的存在是透明的。

**负载均衡设备在这种情况下，更类似于一个代理服务器。负载均衡和前端的客户端以及后端的服务器会分别建立 TCP 连接。** 所以从这个技术原理上来看，七层负载均衡明显的对负载均衡设备的要求更高
### 应用场景
- Web应用负载均衡：分发HTTP或HTTPS流量到多个Web服务器。
- API网关：作为API网关，分发API请求到多个后端服务。
- 内容分发网络（CDN）：根据内容类型和用户位置进行智能分发。
### 常见的七层负载均衡设备
- Nginx
  - Nginx是一款开源的高性能HTTP和反向代理服务器，也是一个常用的七层负载均衡器。它支持动静分离、URL重写、内容缓存等功能。
- HAProxy
  - HAProxy是一款免费、开源的高性能负载均衡软件，支持TCP和HTTP应用的负载均衡。它广泛应用于提高网站的可用性和性能。
- F5 BIG-IP
  - F5 BIG-IP是一款高性能的硬件负载均衡设备，提供广泛的应用交付服务。包括但不限于四层（传输层）和七层（应用层）的负载均衡。这使得F5 BIG-IP能够根据IP地址和端口号（四层）以及HTTP/HTTPS请求的内容（七层），如URL、HTTP头、Cookie等，进行智能流量分发。

## 四层和七层区别
### 工作层次
- 四层负载均衡工作在OSI模型的传输层，主要基于TCP/UDP协议。
- 七层负载均衡工作在OSI模型的应用层，主要基于HTTP/HTTPS协议。
### 智能性
- 从理论上讲，七层模型能够修改用户的所有请求。例如对文件 header 添加信息，根据不同的文件类型进行分类转发。极大的提升了应用系统在网络层的灵活性。
- 四层模型仅支持基于网络层的需求转发，不能修改用户请求的内容。

例如访问一个网站的用户流量，可以通过七层的方式：
- 将图片类的请求转发到特定的图片服务器并可以使用缓存技术
- 将文字类的请求转发到特定的文字服务器并可以使用压缩技术
### 安全性
- 七层负载均衡由于具有 OSI 模型的全部功能，能更容易抵御来自网络的攻击
- 四层模型从原理上讲，会直接将用户的请求转发给后端节点，无法直接抵御网络攻击

网络中最常见的 SYN 泛洪攻击，即黑客控制众多源客户端，使用虚假 IP 地址对同一目标发送 SYN 攻击，通常这种攻击会大量发送 SYN 报文，耗尽服务器上的相关资源，以达到 DoS 攻击的目的。

从技术原理上也可以看出，四层模式下这些 SYN 攻击都会被转发到后端的服务器上；而七层模式下这些 SYN 攻击自然在负载均衡设备上就截止，不会影响后台服务器的正常运营。

另外负载均衡设备可以在七层层面设定多种策略，过滤特定报文，例如 SQL 注入 等应用层面的特定攻击手段，从应用层面进一步提高系统整体安全。

### 复杂度
- 四层模型一般比较简单的架构，容易管理，容易定位问题。
- 七层模型架构比较复杂，通常也需要考虑结合四层模型的混用情况，出现问题定位比较复杂。

### 效率比
- 四层模型基于更底层的设置，处理速度快，对系统资源消耗少，适用于需要快速响应的场景，但应用范围有限。
- 七层模型处理速度相对较慢，对系统资源消耗较大，适用于需要高度定制化处理的场景。

## 一些主流的负载均衡设备
Nginx、LVS 及 HAProxy 是目前使用最为广泛的三种负载均衡软件。

**负载均衡设备存在硬件和软件两种**
- 常见的硬件有比较昂贵的 F5 和 Array 等商用的负载均衡器，它的优点就是有专业的维护团队来对这些服务进行维护、缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有需要使用；
- 另外一种就是类似于 Nginx/LVS/HAProxy 的基于 Linux 的开源免费的负载均衡软件，这些都是通过软件级别来实现，所以费用非常低廉。

**一般对负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术**
- 如果是中小型的 Web 应用，比如日 PV 小于 1000 万，用 Nginx 就完全可以了
- 如果机器不少，可以用 DNS 轮询，LVS 所耗费的机器还是比较多的
- 大型网站或重要的服务，且服务器比较多时，可以考虑用 LVS

**目前关于网址架构比较合理且流行的架构方案**
- Web 前端采用 Nginx/HAProxy + Keepalived 作负载均衡器
- 后端采用 MySQL 数据库一主多从和读写分离，采用 LVS + Keepalived 的架构。当然要根据项目具体需求制定方案

### Nginx
#### 优点
- 工作在应用层，**可以针对 HTTP 应用做一些分流的策略**。
    - 如针对域名、目录结构等。它的正则规则比 HAProxy 更为强大和灵活，这也是它目前广泛流行的主要原因之一。Nginx 单凭这点可利用的场合就远多于 LVS 了。
- **Nginx 对网络稳定性的依赖非常小**，理论上能 ping 通就就能进行负载功能，这个也是它的优势之一。相反 LVS 对网络稳定性依赖比较大。
- **Nginx 安装和配置比较简单**，测试起来比较方便，它基本能把错误用日志打印出来。LVS 的配置、测试就要花比较长的时间了，LVS 对网络依赖比较大。
- **可以承担高负载压力且稳定**，在硬件不差的情况下一般能支撑几万次的并发量。负载度比 LVS 相对小些。
- **Nginx 可以通过端口检测到服务器内部的故障**，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持 url 来检测
    - 比如用户正在上传一个文件，而处理该上传的节点刚好在上传过程中出现故障，Nginx 会把上传切到另一台服务器重新处理
    - 而 LVS 就直接断掉了，如果是上传一个很大的文件或者很重要的文件的话，用户可能会因此而不满。
- Nginx 不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也**是功能强大的 Web 应用服务器**
- Nginx 现在作为 Web 反向加速缓存越来越成熟了，速度比传统的 Squid 服务器更快，可以考虑用其作为反向代理加速器
- **Nginx 可作为中层反向代理使用**，这一层面 Nginx 基本上无对手，唯一可以对比 Nginx 的就只有 lighttpd 了，不过 lighttpd 目前还没有做到 Nginx 完全的功能，配置也不那么清晰易读，社区资料也远远没 Nginx 活跃
- **Nginx 也可作为静态网页和图片服务器**，这方面的性能也无对手。还有 Nginx 社区非常活跃，第三方模块也很多
#### 缺点
- Nginx 仅能支持 http、https 和 Email 协议，这样就在适用范围上面小些，这个是它的缺点
- 对后端服务器的健康检查，只支持通过端口来检测，不支持通过 url 来检测。不支持 Session 的直接保持，但能通过 ip_hash 来解决
### LVS
#### 优点
- 抗负载能力强、性能高，能达到硬件 F5 的 60%；对内存和 CPU 资源消耗比较低。
- 稳定性、可靠性好，自身有完美的热备方案；（如：LVS+Keepalived）。
- 工作在网络 4 层，通过 vrrp 协议转发（仅作分发之用），具体的流量由 linux 内核处理，因此没有流量的产生。
- 应用范围比较广，可以对所有应用做负载均衡。
#### 缺点
- 不支持正则处理，不能做动静分离。
- 配置复杂，对网络依赖比较大。
### HAProxy
- HAProxy 也是支持虚拟主机的
- HAProxy 的优点能够补充 Nginx 的一些缺点，比如支持 Session 的保持，Cookie 的引导；同时支持通过获取指定的 url 来检测后端服务器的状态
- HAProxy 跟 LVS 类似，本身就只是一款负载均衡软件；单纯从效率上来讲 HAProxy 会比 Nginx 有更出色的负载均衡速度，在并发处理上也是优于 Nginx 的
- HAProxy 支持 TCP 协议的负载均衡转发，可以对 MySQL 读进行负载均衡。对后端的 MySQL 节点进行检测和负载均衡，可以用 LVS + Keepalived 对 MySQL 主从做负载均衡
- HAProxy 负载均衡策略非常多，HAProxy 的负载均衡算法现在具体有 8 种

## 如何使用负载均衡设备
现在对网络负载均衡的使用是随着网站规模的提升根据不同的阶段来使用不同的技术
### 第一阶段
利用 Nginx 或 HAProxy 进行单点的负载均衡。

**这一阶段服务器规模刚脱离开单服务器、单数据库的模式**，需要一定的负载均衡，但是仍然规模较小没有专业的维护团队来进行维护，也没有需求进行大规模的网站部署。这样利用 Nginx 或 HAproxy 就是第一选择，此时这些东西上手快， 配置容易，在七层之上利用 HTTP 协议就可以

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/第一阶段.png" height="300px" />

#### 网关
配置了负载均衡之后，还有一个问题。比如有一个黑客对服务器进行 DOS 攻击，此时不管有多少台服务器都很难支撑。为了防止这种情况，访问到服务器前再加一层鉴权操作，处理这一层鉴权操作的就叫网关（Gateway）。为了避免单点故障，网关也要以集群的形式存在。这样的话访问服务器前都要经过网关这一层，鉴权通过后才能转发到服务器中，否则就返回错误信息。

除了鉴权操作以外，网关还起到防爬、协议转换、限流等功能，保证转发到服务器的流量是安全、可控的。

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/网关.png" height="300px" />

#### CDN
对于一些静态资源比如 html、js、css。会通过 CDN 方式引入，并判断 CDN 中是否存在缓存：

- 如果存在则直接返回
- 反之发送请求到 Nginx，Nginx 根据某些规则去判断是否是静态请求：
    - 如果是，则可以优先利用 Nginx 对静态资源的缓存能力
    - 如果没有缓存，再去静态服务器中获取，从而减轻服务器压力。

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/CDN.png" height="300px" />

#### 主备 Nginx
随着业务的发展，为了保证健壮性和避免单点故障，Nginx 也需要部署两台机器，以主备的形式来存在。备 Nginx 会通过 keepalived 机制，使用 Heartbeat（健康检查）来感知主 Nginx 的状态，如果主 Nginx 宕机备用 Nginx 就会成为主 Nginx。

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/主备Nginx.png" height="300px" />

### 第二阶段
随着网络服务进一步扩大，这时 Nginx 已经不能满足，而 LVS 或者商用 Array 就是首要选择，Nginx 此时就作为 LVS 或者 Array 的节点来使用

具体 LVS 或 Array 的选择，是根据公司规模和预算来选择，Array 的应用交付功能非常强大，性价比也远高于 F5，商用首选，但是一般来说这阶段相关人才跟不上业务的提升，所以购买商业负载均衡已经成为了必经之路

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/第二阶段.png" height="300px" />

#### 主备 LVS 和 DNS
如果只有一台 LVS，在流量很大的情况下还是会出现单点故障，最简单的方式就是多加几台。那如何让加的这几台机器能够访问到呢，这个时候就需要使用 DNS 来做域名解析的负载均衡

<img src="https://github.com/zygg1512/myBlog/raw/master/images/Service/负载均衡/主备LVS和DNS.png" height="300px" />

## 负载均衡算法
主要包含下面这几种：
- 轮询（Round Robin）
- 加权轮询（Weighted Round Robbin）
- 最少连接（least Connections）
- 加权最少连接（Weighted Least Connection）
- 随机算法（Random）
- 源地址哈希法 (IP Hash)