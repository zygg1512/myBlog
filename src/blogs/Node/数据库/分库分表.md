# 分库分表
## 前言
**MySQL单表容量在1千万以下是最佳状态**，因为这时它的 BTREE索引树高 在 3~5 之间。

一旦数据库过于庞大，当一张表的数据达到几千万时，查询一次所花的时间会变长。尤其是当写入过于频繁，一台主机支撑的时候就会变得非常困难，并且会面临到扩展瓶颈；而这个时候就需要**分库分表**了。
## 分库分表是什么
简单来说，就是指通过某种特定的条件，将存放在同一个数据库中的数据分散到多个数据库（主机）上面，从而解决单台设备负载过大的问题。

比如单台设备Crash（崩溃）之后，只会出现某部分数据不可用，而不是全部的数据。

分库分表的切分（Sharding）依据其切分规则能够分为两种切分模式

- **垂直（纵向）切分**
- **水平（横向）切分**
## 垂直切分
**垂直切分又可以分为：垂直分库和垂直分表。**

垂直切分的最大特点就是规则简单，实施也更为方便，对应用程序的影响也更小，尤其适合各业务之间的耦合度非常低、相互影响非常小、业务逻辑非常清晰的系统。

在这样的系统中，能够非常简单的做到将不同业务模块所使用的表拆分到不同的数据库中。

### 垂直分库
**垂直分库是指按照业务将表进行分类，分布到不同的数据库上面，每个库可以放在不同的服务器上，它的核心理念是专库专用**

<img src="https://github.com/zygg1512/myBlog/raw/master/images/数据库/垂直分库.png" height="300px" />

一开始是单体服务，所以只有一个数据库，所有的表都在这个库里。后来因为业务需求,单体服务变成微服务治理。所以将之前的一个商品库，拆分成多个数据库。每个微服务对应一个数据库。
### 垂直分表
**按列切分；将一个表按照字段分成多表，每个表存储其中一部分字段**

<img src="https://github.com/zygg1512/myBlog/raw/master/images/数据库/垂直分表.png" height="300px" />

一开始商品表中包含商品的所有字段，但是发现如下问题:

（1）商品详情和商品属性字段较长

（2）获取商品列表的时候不需要显示商品详情，只有在点进商品详情的时候才会展示商品详情信息

所以可以考虑把商品详情和商品属性单独切分一张表，提高查询效率。
### 垂直切分优缺点
#### 优点

- 解决业务系统层面的耦合，业务清晰
- 与微服务的治理类似，也能对不同业务的数据进行分级管理、维护、监控、扩展等
- 高并发场景下，垂直切分一定程度的提升了IO、数据库连接数、单机硬件资源的瓶颈
#### 缺点

- 分库后无法Join，只能通过接口聚合方式解决，提升了开发的复杂度
- 分库后分布式事务处理复杂
- **依然存在单表数据量过大的问题（需要水平切分）**
## 水平切分
当一个应用难以再细粒度的垂直切分或切分后数据量行数巨大，存在单库读写、存储性能瓶颈，这时候就需要进行水平切分了。水平切分也可以分为：水平分库和水平分表
### 水平分库
**水平分库是把同一个表的数据按一定规则拆到不同的数据库中，每个库可以放在不同的服务器上**

水平分库的原因：上面虽然已经把商品库分成3个库，但是随着业务的增加一个订单库也出现QPS过高时，数据库响应速度不及时。一般mysql单机也就1000左右的QPS，如果超过1000就要考虑分库

<img src="https://github.com/zygg1512/myBlog/raw/master/images/数据库/水平分库.png" height="300px" />

### 水平分表
**按行拆分，水平分表是在同一个数据库内，把同一个表的数据按一定规则拆到多个表中**

<img src="https://github.com/zygg1512/myBlog/raw/master/images/数据库/水平分表.png" height="300px" />

### 水平切分优缺点
#### 优点
- 不存在单库数据量过大、解决了高并发的性能瓶颈问题，提升了系统稳定性和负载能力
- 应用端改造较小，不需要拆分业务模块
#### 缺点
- 跨分片的事务一致性难以保证
- 跨库的Join关联查询性能较差
- 数据多次扩展难度和维护量极大
