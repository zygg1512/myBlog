# Tools

å·¥å…·æ˜¯ MCP æœåŠ¡å™¨çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œå…è®¸ AI å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡å™¨ç«¯çš„å‡½æ•°æ¥æ‰§è¡Œå…·ä½“æ“ä½œã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»å·¥å…·ç³»ç»Ÿçš„ API æ¥å£ã€å‚æ•°é…ç½®å’Œä½¿ç”¨æ–¹æ³•ã€‚

å‚è€ƒï¼š[Tools](https://modelcontextprotocol.io/specification/2025-11-25/server/tools)
## registerTool() æ³¨å†Œå·¥å…·

æ³¨å†Œä¸€ä¸ªå·¥å…·ï¼Œä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚

```typescript
registerTool(name: string, config: ToolConfig, callback: ToolCallback): RegisteredTool
```

**è¿”å›å€¼**

| ç±»å‹             | æè¿°                                   |
| ---------------- | -------------------------------------- |
| `RegisteredTool` | æ³¨å†Œçš„å·¥å…·å¯¹è±¡ï¼Œæä¾›å·¥å…·æ§åˆ¶å’Œç®¡ç†æ–¹æ³• |

**å‚æ•°**

| å‚æ•°å     | ç±»å‹           | å¿…å¡« | æè¿°                                            |
| ---------- | -------------- | ---- | ----------------------------------------------- |
| `name`     | `string`       | æ˜¯   | å·¥å…·åç§°ï¼Œå¿…é¡»å”¯ä¸€çš„å­—ç¬¦ä¸²æ ‡è¯†ç¬¦ï¼Œéµå¾ª SEP è§„èŒƒ |
| `config`   | `ToolConfig`   | æ˜¯   | å·¥å…·é…ç½®ä¿¡æ¯å¯¹è±¡                                |
| `callback` | `ToolCallback` | æ˜¯   | å·¥å…·å¤„ç†å‡½æ•°                                    |

`ToolCallback`ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š

```typescript
type ToolCallback = (inputObject, extra: RequestHandlerExtra) => CallToolResult;
```

**config (ToolConfig) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå         | ç±»å‹              | å¿…å¡« | æè¿°                                     |
| -------------- | ----------------- | ---- | ---------------------------------------- |
| `title`        | `string`          | å¦   | å·¥å…·æ˜¾ç¤ºæ ‡é¢˜ï¼Œç”¨äº UI å±•ç¤º               |
| `description`  | `string`          | å¦   | å·¥å…·åŠŸèƒ½çš„è¯¦ç»†æè¿°                       |
| `inputSchema`  | `ZodRawShapeCompat \| AnySchema` | å¦   | è¾“å…¥å‚æ•°çš„ Zod Schema å®šä¹‰ï¼Œç”¨äºå‚æ•°éªŒè¯ |
| `outputSchema` | `ZodRawShapeCompat \| AnySchema` | å¦   | è¾“å‡ºç»“æœçš„ Zod Schema å®šä¹‰ï¼Œç”¨äºç»“æœéªŒè¯ |
| `annotations`  | `ToolAnnotations` | å¦   | å·¥å…·è¡Œä¸ºæ³¨è§£å’Œ UI æç¤ºä¿¡æ¯ï¼ŒåŒ…å«5ä¸ªç‰¹å®šå­—æ®µï¼ˆä¸æ˜¯ä»»æ„å¯¹è±¡ï¼‰ |
| `_meta`        | `Record<string, unknown>` | å¦   | è‡ªå®šä¹‰å…ƒæ•°æ®ï¼Œç”¨äºå­˜å‚¨ä»»æ„é¢å¤–ä¿¡æ¯ï¼ˆæ˜¯ä»»æ„å¯¹è±¡ï¼‰ |

**annotations (ToolAnnotations) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå            | ç±»å‹      | å¿…å¡« | æè¿°                                                         |
| ----------------- | --------- | ---- | ------------------------------------------------------------ |
| `title`           | `string`  | å¦   | è‡ªå®šä¹‰æ˜¾ç¤ºæ ‡é¢˜ï¼Œè¦†ç›–é»˜è®¤æ ‡é¢˜                                 |
| `readOnlyHint`    | `boolean` | å¦   | æ˜¯å¦ä¸ºåªè¯»æ“ä½œï¼Œé»˜è®¤ falseï¼Œtrue è¡¨ç¤ºä¸ä¼šä¿®æ”¹æ•°æ®            |
| `destructiveHint` | `boolean` | å¦   | æ˜¯å¦ä¸ºç ´åæ€§æ“ä½œï¼Œé»˜è®¤ trueï¼Œtrue è¡¨ç¤ºå¯èƒ½åˆ é™¤æˆ–ä¿®æ”¹é‡è¦æ•°æ® |
| `idempotentHint`  | `boolean` | å¦   | æ˜¯å¦ä¸ºå¹‚ç­‰æ“ä½œï¼Œé»˜è®¤ falseï¼Œtrue è¡¨ç¤ºå¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ        |
| `openWorldHint`   | `boolean` | å¦   | æ˜¯å¦ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’ï¼Œé»˜è®¤ trueï¼Œtrue è¡¨ç¤ºä¼šè®¿é—®å¤–éƒ¨èµ„æº       |

**annotationsä½œç”¨**ï¼šæä¾›ç»“æ„åŒ–è¯­ä¹‰æç¤ºï¼Œå¸®åŠ©å®¢æˆ·ç«¯ç†è§£å·¥å…·è¡Œä¸ºã€‚åŒ…å«5ä¸ªç‰¹å®šå­—æ®µï¼ˆtitleã€readOnlyHintã€destructiveHintã€idempotentHintã€openWorldHintï¼‰ï¼Œç”¨äºUIå±•ç¤ºå’Œæ“ä½œæç¤ºã€‚è¿™äº›æ˜¯åè®®å®šä¹‰çš„å­—æ®µï¼Œå®¢æˆ·ç«¯åº”è¯¥ç†è§£å¹¶æ®æ­¤è°ƒæ•´ç•Œé¢æ˜¾ç¤ºå’Œäº¤äº’é€»è¾‘ã€‚

**`_meta` (å…ƒæ•°æ®) å¸¸ç”¨å­—æ®µï¼š**

| å­—æ®µå          | ç±»å‹       | å¿…å¡« | æè¿°                                                 |
| --------------- | ---------- | ---- | ---------------------------------------------------- |
| `version`       | `string`   | å¦   | å·¥å…·ç‰ˆæœ¬å·ï¼Œå¦‚ "1.0.0"                               |
| `author`        | `string`   | å¦   | å·¥å…·ä½œè€…ä¿¡æ¯                                         |
| `documentation` | `string`   | å¦   | æ–‡æ¡£é“¾æ¥ URL                                         |
| `examples`      | `object[]` | å¦   | ä½¿ç”¨ç¤ºä¾‹æ•°ç»„ï¼Œæ¯ä¸ªç¤ºä¾‹åŒ…å« titleã€inputã€description |

**_metaä½œç”¨**ï¼šçµæ´»å…ƒæ•°æ®å­—æ®µï¼Œç”¨äºå­˜å‚¨ä»»æ„è‡ªå®šä¹‰æ•°æ®ã€‚ç±»å‹ä¸º`Record<string, unknown>`ï¼Œå¯ä»¥åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ã€ä½œè€…ã€åˆ†ç±»æ ‡ç­¾ã€æ–‡æ¡£é“¾æ¥ã€æ€§èƒ½æŒ‡æ ‡ç­‰ã€‚è¿™äº›æ•°æ®ä¸å‚ä¸åè®®è¯­ä¹‰ï¼Œå®¢æˆ·ç«¯ä¸ä¿è¯ç†è§£æˆ–ä½¿ç”¨ã€‚

**ç¤ºä¾‹**

```typescript
import { McpServer } from '@modelcontextprotocol/server';
import * as z from 'zod/v4';

const server = new McpServer({
    name: 'tool-example-server',
    version: '1.0.0',
});

// åŸºç¡€å·¥å…·æ³¨å†Œ
const registeredTool = server.registerTool(
    'calculator', // å·¥å…·åç§°ï¼ˆå¿…éœ€ï¼‰
    {
        title: 'è®¡ç®—å™¨', // æ˜¾ç¤ºæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
        description: 'æ‰§è¡ŒåŸºæœ¬æ•°å­¦è®¡ç®—', // å·¥å…·æè¿°ï¼ˆå¯é€‰ï¼‰
        inputSchema: {
            // è¾“å…¥å‚æ•°Schemaï¼ˆå¯é€‰ï¼‰
            expression: z.string().describe('æ•°å­¦è¡¨è¾¾å¼ï¼Œå¦‚ "2 + 3 * 4"'),
            precision: z
                .number()
                .min(0)
                .max(10)
                .default(2)
                .describe('å°æ•°ç²¾åº¦'),
        },
    },
    async ({ expression, precision = 2 }, extra) => {
        // å·¥å…·å®ç°å‡½æ•°
        try {
            // å®‰å…¨çš„æ•°å­¦è¡¨è¾¾å¼æ±‚å€¼ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ä¸“é—¨çš„æ•°å­¦åº“ï¼‰
            const result = Function(`"use strict" return (${expression})`)();

            return {
                content: [
                    {
                        type: 'text',
                        text: `è®¡ç®—ç»“æœï¼š${expression} = ${Number(
                            result
                        ).toFixed(precision)}`,
                    },
                ],
            };
        } catch (error) {
            return {
                content: [
                    {
                        type: 'text',
                        text: `è®¡ç®—é”™è¯¯ï¼š${error.message}`,
                    },
                ],
            };
        }
    }
);
```

## è¿”å›å€¼ RegisteredTool

`registerTool` è¿”å›ä¸€ä¸ª `RegisteredTool` å¯¹è±¡ï¼Œæä¾›å·¥å…·æ§åˆ¶å’Œç®¡ç†æ–¹æ³•ã€‚

**RegisteredTool å±æ€§**

| å±æ€§å         | ç±»å‹              | åªè¯» | æè¿°                   |
| -------------- | ----------------- | ---- | ---------------------- |
| `title`        | `string`          | æ˜¯   | å·¥å…·æ˜¾ç¤ºæ ‡é¢˜           |
| `description`  | `string`          | æ˜¯   | å·¥å…·åŠŸèƒ½æè¿°           |
| `inputSchema`  | `AnySchema`       | æ˜¯   | è¾“å…¥å‚æ•° Schema å¯¹è±¡   |
| `outputSchema` | `AnySchema`       | æ˜¯   | è¾“å‡ºç»“æœ Schema å¯¹è±¡   |
| `annotations`  | `ToolAnnotations` | æ˜¯   | å·¥å…·è¡Œä¸ºæ³¨è§£é…ç½®       |
| `execution`    | `ToolExecution`   | æ˜¯   | æ‰§è¡Œé…ç½®ï¼ŒåŒ…å« taskSupport å­—æ®µï¼ˆ'forbidden'ã€'optional'ã€'required'ï¼‰ |
| `_meta`        | `Record<string, unknown>` | æ˜¯   | è‡ªå®šä¹‰å…ƒæ•°æ®ä¿¡æ¯       |
| `handler`      | `AnyToolHandler`  | æ˜¯   | å·¥å…·å¤„ç†å‡½æ•°           |
| `enabled`      | `boolean`         | æ˜¯   | å½“å‰æ˜¯å¦å¯ç”¨çŠ¶æ€       |

**RegisteredTool æ–¹æ³•**

| æ–¹æ³•å    | å‚æ•°         | è¿”å›å€¼ | æè¿°                            |
| --------- | ------------ | ------ | ------------------------------- |
| enable()  | æ—            | `void` | å¯ç”¨å·¥å…·ï¼Œè®¾ç½® enabled ä¸º true  |
| disable() | æ—            | `void` | ç¦ç”¨å·¥å…·ï¼Œè®¾ç½® enabled ä¸º false |
| remove()  | æ—            | `void` | ä»æœåŠ¡å™¨ä¸­å®Œå…¨ç§»é™¤å·¥å…·          |
| update()  | updates å¯¹è±¡ | `void` | åŠ¨æ€æ›´æ–°å·¥å…·çš„å„ç§å±æ€§          |

**update() æ–¹æ³•å‚æ•°**

| å­—æ®µå         | ç±»å‹              | å¿…å¡« | æè¿°                            |
| -------------- | ----------------- | ---- | ------------------------------- |
| `name`         | string \|`null`   | å¦   | æ›´æ”¹å·¥å…·åç§°ï¼Œnull è¡¨ç¤ºåˆ é™¤å·¥å…· |
| `title`        | `string`          | å¦   | æ›´æ–°æ˜¾ç¤ºæ ‡é¢˜                    |
| `description`  | `string`          | å¦   | æ›´æ–°å·¥å…·æè¿°                    |
| `inputSchema` | `object`          | å¦   | æ›´æ–°è¾“å…¥å‚æ•° Schema (ZodRawShapeCompat æˆ– AnySchema) |
| `outputSchema` | `object`          | å¦   | æ›´æ–°è¾“å‡º Schema                 |
| `annotations`  | `ToolAnnotations` | å¦   | æ›´æ–°å·¥å…·æ³¨è§£                    |
| `_meta`        | `object`          | å¦   | æ›´æ–°è‡ªå®šä¹‰å…ƒæ•°æ®                |
| `callback`     | `ToolCallback`    | å¦   | æ›´æ–°å·¥å…·å¤„ç†å‡½æ•°                |
| `enabled`      | `boolean`         | å¦   | æ›´æ–°å¯ç”¨çŠ¶æ€                    |

**ä½¿ç”¨ç¤ºä¾‹**

```typescript
// æ‰€æœ‰é…ç½®å±æ€§éƒ½ä¼šä¿å­˜åœ¨è¿”å›çš„å¯¹è±¡ä¸­
const tool = server.registerTool('example', config, handler);

// è®¿é—®å·¥å…·é…ç½®
console.log(tool.title); // å·¥å…·æ˜¾ç¤ºæ ‡é¢˜
console.log(tool.description); // å·¥å…·æè¿°
console.log(tool.enabled); // å½“å‰å¯ç”¨çŠ¶æ€
console.log(tool.inputSchema); // è½¬æ¢åçš„Zod Schemaå¯¹è±¡
console.log(tool.annotations); // å·¥å…·æ³¨è§£é…ç½®
console.log(tool._meta); // è‡ªå®šä¹‰å…ƒæ•°æ®

// å¯ç”¨/ç¦ç”¨å·¥å…·
tool.enable(); // å¯ç”¨å·¥å…·ï¼Œè®¾ç½® enabled = true
tool.disable(); // ç¦ç”¨å·¥å…·ï¼Œè®¾ç½® enabled = false

// ç§»é™¤å·¥å…·
tool.remove(); // ä»æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ä¸­å®Œå…¨åˆ é™¤ï¼›ç­‰åŒäº tool.update({ name: null })

// æ›´æ–°å·¥å…·
// update æ–¹æ³•å…è®¸åŠ¨æ€ä¿®æ”¹å·¥å…·çš„å„ç§å±æ€§
tool.update({
    title: 'æ–°çš„å·¥å…·æ ‡é¢˜',
    description: 'æ›´æ–°åçš„æè¿°',
    enabled: false,
    _meta: { version: '2.0.0' },
});

// æ›´æ”¹å·¥å…·åç§°ï¼ˆä¼šä»åŸåç§°ä¸‹ç§»é™¤ï¼Œåœ¨æ–°åç§°ä¸‹æ³¨å†Œï¼‰
tool.update({ name: 'new-tool-name' });

// åˆ é™¤å·¥å…·ï¼ˆä¸ remove() ç­‰æ•ˆï¼‰
tool.update({ name: null });

// æ›´æ–°å¤„ç†å‡½æ•°
tool.update({
    callback: async ({ newParam }, extra) => {
        // æ–°çš„å¤„ç†é€»è¾‘
        return { content: [{ type: 'text', text: 'æ›´æ–°åçš„å¤„ç†' }] };
    },
});
```

## å·¥å…·å¤„ç†å‡½æ•°çš„è¿”å›å€¼ CallToolResult

**CallToolResult å­—æ®µ**

| å­—æ®µå              | ç±»å‹             | å¿…å¡« | æè¿°                                   |
| ------------------- | ---------------- | ---- | -------------------------------------- |
| `content`           | `ContentBlock[]` | æ˜¯   | å†…å®¹å—æ•°ç»„ï¼Œç”¨äºæ˜¾ç¤ºç»™ç”¨æˆ·             |
| `structuredContent` | `object`         | å¦   | ç»“æ„åŒ–æ•°æ®ï¼Œå½“å®šä¹‰ outputSchema æ—¶å¿…éœ€ |
| `isError`           | `boolean`        | å¦   | æ˜¯å¦ä¸ºé”™è¯¯ç»“æœï¼Œé»˜è®¤ false             |
| `_meta`             | `object`         | å¦   | å…ƒæ•°æ®ä¿¡æ¯                             |

### ContentBlock

ContentBlock æ”¯æŒå¤šç§å†…å®¹ç±»å‹ï¼Œæ¯ç§ç±»å‹éƒ½æœ‰ç‰¹å®šçš„å­—æ®µç»“æ„ï¼š

**ContentBlock ç±»å‹æšä¸¾**

| ç±»å‹               | type å€¼         | æè¿°                         |
| ------------------ | --------------- | ---------------------------- |
| `TextContent`      | 'text'          | æ–‡æœ¬å†…å®¹ï¼Œæœ€å¸¸ç”¨çš„å†…å®¹ç±»å‹   |
| `ImageContent`     | 'image'         | å›¾ç‰‡å†…å®¹ï¼Œæ”¯æŒ base64 ç¼–ç    |
| `AudioContent`     | 'audio'         | éŸ³é¢‘å†…å®¹ï¼Œæ”¯æŒ base64 ç¼–ç    |
| `ResourceLink`     | 'resource_link' | èµ„æºé“¾æ¥ï¼ŒæŒ‡å‘å¤–éƒ¨èµ„æº       |
| `EmbeddedResource` | 'resource'      | åµŒå…¥å¼èµ„æºï¼ŒåŒ…å«å®Œæ•´èµ„æºæ•°æ® |

**TextContent å­—æ®µ**

| å­—æ®µå        | ç±»å‹     | å¿…å¡« | æè¿°         |
| ------------- | -------- | ---- | ------------ |
| `type`        | 'text'   | æ˜¯   | å†…å®¹ç±»å‹æ ‡è¯† |
| `text`        | `string` | æ˜¯   | æ–‡æœ¬å†…å®¹     |
| `annotations` | `object` | å¦   | å¯é€‰æ³¨è§£ä¿¡æ¯ |
| `_meta`       | `object` | å¦   | å…ƒæ•°æ®       |

**ImageContent å­—æ®µ**

| å­—æ®µå        | ç±»å‹     | å¿…å¡« | æè¿°                      |
| ------------- | -------- | ---- | ------------------------- |
| `type`        | 'image'  | æ˜¯   | å†…å®¹ç±»å‹æ ‡è¯†              |
| `data`        | `string` | æ˜¯   | base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®     |
| `mimeType`    | `string` | æ˜¯   | MIME ç±»å‹ï¼Œå¦‚ 'image/png' |
| `annotations` | `object` | å¦   | å¯é€‰æ³¨è§£ä¿¡æ¯              |
| `_meta`       | `object` | å¦   | å…ƒæ•°æ®                    |

**AudioContent å­—æ®µ**

| å­—æ®µå        | ç±»å‹     | å¿…å¡« | æè¿°                      |
| ------------- | -------- | ---- | ------------------------- |
| `type`        | 'audio'  | æ˜¯   | å†…å®¹ç±»å‹æ ‡è¯†              |
| `data`        | `string` | æ˜¯   | base64 ç¼–ç çš„éŸ³é¢‘æ•°æ®     |
| `mimeType`    | `string` | æ˜¯   | MIME ç±»å‹ï¼Œå¦‚ 'audio/mp3' |
| `annotations` | `object` | å¦   | å¯é€‰æ³¨è§£ä¿¡æ¯              |
| `_meta`       | `object` | å¦   | å…ƒæ•°æ®                    |

**ResourceLink å­—æ®µ**

| å­—æ®µå        | ç±»å‹            | å¿…å¡« | æè¿°          |
| ------------- | --------------- | ---- | ------------- |
| `type`        | 'resource_link' | æ˜¯   | å†…å®¹ç±»å‹æ ‡è¯†  |
| `uri`         | `string`        | æ˜¯   | èµ„æº URI åœ°å€ |
| `name`        | `string`        | æ˜¯   | èµ„æºåç§°      |
| `description` | `string`        | å¦   | èµ„æºæè¿°      |
| `mimeType`    | `string`        | å¦   | MIME ç±»å‹     |
| `annotations` | `object`        | å¦   | å¯é€‰æ³¨è§£ä¿¡æ¯  |
| `_meta`       | `object`        | å¦   | å…ƒæ•°æ®        |

**annotations (æ³¨è§£) é€šç”¨å­—æ®µ**

| å­—æ®µå         | ç±»å‹                      | å¿…å¡« | æè¿°             |
| -------------- | ------------------------- | ---- | ---------------- |
| `audience`     | ('user' \| 'assistant')[] | å¦   | ç›®æ ‡å—ä¼—         |
| `priority`     | `number`                  | å¦   | ä¼˜å…ˆçº§ï¼ŒèŒƒå›´ 0-1 |
| `lastModified` | `string`                  | å¦   | æœ€åä¿®æ”¹æ—¶é—´     |

**EmbeddedResource å­—æ®µ**

| å­—æ®µå        | ç±»å‹                          | å¿…å¡« | æè¿°         |
| ------------- | ----------------------------- | ---- | ------------ |
| `type`        | 'resource'                    | æ˜¯   | å†…å®¹ç±»å‹æ ‡è¯† |
| `resource`    | TextResource \|`BlobResource` | æ˜¯   | èµ„æºå†…å®¹å¯¹è±¡ |
| `annotations` | `object`                      | å¦   | å¯é€‰æ³¨è§£ä¿¡æ¯ |
| `_meta`       | `object`                      | å¦   | å…ƒæ•°æ®       |

**TextResource å­—æ®µ**

| å­—æ®µå     | ç±»å‹     | å¿…å¡« | æè¿°          |
| ---------- | -------- | ---- | ------------- |
| `uri`      | `string` | æ˜¯   | èµ„æº URI åœ°å€ |
| `text`     | `string` | æ˜¯   | æ–‡æœ¬å†…å®¹      |
| `mimeType` | `string` | å¦   | MIME ç±»å‹     |

**BlobResource å­—æ®µ**

| å­—æ®µå     | ç±»å‹     | å¿…å¡« | æè¿°                    |
| ---------- | -------- | ---- | ----------------------- |
| `uri`      | `string` | æ˜¯   | èµ„æº URI åœ°å€           |
| `blob`     | `string` | æ˜¯   | base64 ç¼–ç çš„äºŒè¿›åˆ¶æ•°æ® |
| `mimeType` | `string` | å¦   | MIME ç±»å‹               |

### structuredContent

å½“å·¥å…·å®šä¹‰äº† `outputSchema` æ—¶ï¼Œè¿”å›ç»“æœä¸­å¿…é¡»æä¾› `structuredContent` å­—æ®µï¼Œè¯¥å­—æ®µå¿…é¡»ç¬¦åˆå®šä¹‰çš„ Schema ç»“æ„ã€‚

**ä½¿ç”¨åœºæ™¯**

| åœºæ™¯                | æ˜¯å¦å¿…éœ€ | æè¿°                                     |
| ------------------- | -------- | ---------------------------------------- |
| å®šä¹‰äº† outputSchema | æ˜¯       | å¿…é¡»æä¾› structuredContent ä¸”ç¬¦åˆ Schema |
| æœªå®šä¹‰ outputSchema | å¦       | å¯é€‰æä¾›ï¼Œç”¨äºç»“æ„åŒ–æ•°æ®ä¼ è¾“             |
| isError ä¸º true     | å¦       | é”™è¯¯æƒ…å†µä¸‹ä¼šè·³è¿‡ Schema éªŒè¯             |

```typescript
// ç¤ºä¾‹ï¼šoutputSchemaå®šä¹‰
outputSchema: {
  success: z.boolean(),
  data: z.object({
    id: z.string(),
    name: z.string()
  }),
  timestamp: z.string()
}

// å¯¹åº”çš„structuredContent
structuredContent: {
  success: true,
  data: {
    id: "123",
    name: "example"
  },
  timestamp: "2024-01-01T00:00:00Z"
}
```

### isError é”™è¯¯æ ‡è¯†

`isError` å­—æ®µç”¨äºæ ‡è¯†å·¥å…·æ‰§è¡Œæ˜¯å¦å‡ºé”™ï¼Œå½±å“å®¢æˆ·ç«¯çš„å¤„ç†è¡Œä¸ºã€‚

**isError å­—æ®µè¯´æ˜**

| å€¼      | é»˜è®¤å€¼  | è¡Œä¸ºæè¿°                                    |
| ------- | ------- | ------------------------------------------- |
| `true`  | -       | æ ‡è¯†ä¸ºé”™è¯¯ç»“æœï¼Œè·³è¿‡ structuredContent éªŒè¯ |
| `false` | æ˜¯      | æ ‡è¯†ä¸ºæ­£å¸¸ç»“æœï¼Œè¿›è¡Œå¸¸è§„éªŒè¯                |
| æœªè®¾ç½®  | `false` | ç­‰åŒäº falseï¼ŒæŒ‰æ­£å¸¸ç»“æœå¤„ç†                |

å¼‚å¸¸è¿”å›æ–¹å¼ï¼š

1. é€šè¿‡`throw error`çš„æ–¹å¼æŠ›å‡ºçš„å¼‚å¸¸ä¼šè¢«`MCP`æ•è·å¹¶åŒ…è£…æˆå¦‚ä¸‹å½¢å¼ï¼š

```typescript
{
    content: [
        {
            type: 'text',
            text: errorMessage
        }
    ],
    isError: true
}
```

2. æ‰‹åŠ¨è®¾ç½®å¹¶è¿”å›å¼‚å¸¸æ ¼å¼

```typescript
// ç¤ºä¾‹ï¼šæ‰‹åŠ¨è¿”å›é”™è¯¯ç»“æœ
async ({ param }, extra) => {
    if (!param) {
        return {
            content: [
                {
                    type: 'text',
                    text: 'param ä¸èƒ½ä¸ºç©º',
                },
            ],
            isError: true,
        };
    }
    // ...å…¶ä»–é€»è¾‘
};
```

## RequestHandlerExtra ä¸Šä¸‹æ–‡

æ¯ä¸ªå·¥å…·å¤„ç†å‡½æ•°éƒ½ä¼šæ¥æ”¶ä¸€ä¸ª `extra` å‚æ•°ï¼ŒåŒ…å«ä¸Šä¸‹æ–‡ä¿¡æ¯å’ŒåŒå‘é€šä¿¡èƒ½åŠ›ã€‚

### åŸºç¡€ä¸Šä¸‹æ–‡ä¿¡æ¯

| å­—æ®µå        | ç±»å‹          | å¿…å¡« | æè¿°                                               |
| ------------- | ------------- | ---- | -------------------------------------------------- |
| `signal`      | `AbortSignal` | æ˜¯   | è¯·æ±‚å–æ¶ˆä¿¡å·ï¼Œç”¨äºé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œä¸­æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ |
| `sessionId`   | `string`      | å¦   | ä¼ è¾“å±‚ä¼šè¯ IDï¼Œå¤šä¼šè¯ç¯å¢ƒä¸‹åŒºåˆ†ä¸åŒå®¢æˆ·ç«¯è¿æ¥      |
| `requestId`   | `RequestId`   | æ˜¯   | JSON-RPC è¯·æ±‚ IDï¼Œç”¨äºæ—¥å¿—è®°å½•ã€é”™è¯¯è¿½è¸ªã€è°ƒè¯•     |
| `_meta`       | `RequestMeta` | å¦   | åŸå§‹è¯·æ±‚çš„å…ƒæ•°æ®ä¿¡æ¯                               |
| `requestInfo` | `RequestInfo` | å¦   | åŸå§‹ HTTP è¯·æ±‚ä¿¡æ¯ï¼ˆå¦‚æœé€šè¿‡ HTTP ä¼ è¾“ï¼‰           |

```typescript
async ({ param }, extra) => {
    // è¯·æ±‚å–æ¶ˆæ£€æŸ¥
    if (extra.signal.aborted) {
        throw new Error('è¯·æ±‚å·²è¢«å®¢æˆ·ç«¯å–æ¶ˆ');
    }

    // ä¼šè¯å’Œè¯·æ±‚æ ‡è¯†
    console.log('ä¼šè¯ID:', extra.sessionId); // ä¼ è¾“å±‚ä¼šè¯æ ‡è¯†
    console.log('è¯·æ±‚ID:', extra.requestId); // JSON-RPCæ¶ˆæ¯ID
    console.log('å…ƒæ•°æ®:', extra._meta); // å®¢æˆ·ç«¯å‘é€çš„å…ƒæ•°æ®

    // HTTPè¯·æ±‚ä¿¡æ¯ï¼ˆå¦‚æœé€šè¿‡HTTPä¼ è¾“ï¼‰
    if (extra.requestInfo) {
        console.log('HTTPæ–¹æ³•:', extra.requestInfo.method);
        console.log('è¯·æ±‚å¤´:', extra.requestInfo.headers);
        console.log('ç”¨æˆ·ä»£ç†:', extra.requestInfo.userAgent);
    }
};
```

### è®¤è¯ä¿¡æ¯

| å­—æ®µå     | ç±»å‹       | å¿…å¡« | æè¿°                                             |
| ---------- | ---------- | ---- | ------------------------------------------------ |
| `authInfo` | `AuthInfo` | å¦   | å·²éªŒè¯çš„è®¿é—®ä»¤ç‰Œä¿¡æ¯ï¼Œç”¨äºæƒé™æ£€æŸ¥ã€ç”¨æˆ·èº«ä»½éªŒè¯ |

```typescript
async ({ param }, extra) => {
    // æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
    if (!extra.authInfo) {
        throw new Error('æ­¤æ“ä½œéœ€è¦è®¤è¯');
    }

    // è®¿é—®è®¤è¯ä¿¡æ¯
    const auth = extra.authInfo;
    console.log('å®¢æˆ·ç«¯ID:', auth.clientId); // OAuthå®¢æˆ·ç«¯ID
    console.log('ç”¨æˆ·ID:', auth.userId); // ç”¨æˆ·æ ‡è¯†
    console.log('æƒé™èŒƒå›´:', auth.scopes); // æˆæƒèŒƒå›´æ•°ç»„
    console.log('ä»¤ç‰Œç±»å‹:', auth.tokenType); // é€šå¸¸ä¸º 'Bearer'
    console.log('è¿‡æœŸæ—¶é—´:', auth.expiresAt); // ä»¤ç‰Œè¿‡æœŸæ—¶é—´

    // æƒé™æ£€æŸ¥
    if (!auth.scopes.includes('read:data')) {
        throw new Error('æƒé™ä¸è¶³ï¼šéœ€è¦ read:data æƒé™');
    }
};
```

### åŒå‘é€šä¿¡æ–¹æ³•

| æ–¹æ³•å             | å‚æ•°                                                                   | è¿”å›å€¼                     | æè¿°                                           |
| ------------------ | ---------------------------------------------------------------------- | -------------------------- | ---------------------------------------------- |
| `sendNotification` | ` notification: SendNotification<T>`                                     | `Promise<void>`            | å‘é€é€šçŸ¥åˆ°å®¢æˆ·ç«¯ï¼Œç”¨äºè¿›åº¦æ›´æ–°ã€çŠ¶æ€å˜æ›´é€šçŸ¥   |
| `sendRequest`      | `request: SendRequest<T>, resultSchema: U, options?: TaskRequestOptions` | `Promise<SchemaOutput<U>>` | å‘å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œç”¨äºåŒå‘é€šä¿¡ã€å®¢æˆ·ç«¯èƒ½åŠ›è°ƒç”¨ |

```typescript
async ({ param }, extra) => {
    // å‘é€è¿›åº¦é€šçŸ¥
    await extra.sendNotification({
        method: 'notifications/progress',
        params: {
            operation: 'data-processing',
            progress: 0.3,
            message: 'æ­£åœ¨å¤„ç†æ•°æ®...',
            details: { processed: 30, total: 100 },
        },
    });

    // å‘å®¢æˆ·ç«¯è¯·æ±‚LLMç”Ÿæˆ
    const aiResponse = await extra.sendRequest(
        {
            method: 'sampling/createMessage',
            params: {
                messages: [
                    {
                        role: 'user',
                        content: { type: 'text', text: 'è¯·å¸®æˆ‘æ€»ç»“è¿™æ®µæ–‡æœ¬' },
                    },
                ],
                maxTokens: 500,
            },
        },
        CreateMessageRequestSchema // éªŒè¯è¿”å›ç»“æœçš„Schema
    );

    // è¯·æ±‚ç”¨æˆ·è¾“å…¥
    const userInput = await extra.sendRequest(
        {
            method: 'elicitation/create',
            params: {
                mode: 'form',
                message: 'è¯·æä¾›é¢å¤–ä¿¡æ¯',
                requestedSchema: {
                    type: 'object',
                    properties: {
                        name: { type: 'string', title: 'å§“å' },
                        email: {
                            type: 'string',
                            format: 'email',
                            title: 'é‚®ç®±',
                        },
                    },
                    required: ['name'],
                },
            },
        },
        ElicitationCreateRequestSchema
    );

    if (userInput.action === 'accept') {
        console.log('ç”¨æˆ·è¾“å…¥:', userInput.content);
    }
};
```

### ä¼ è¾“æ§åˆ¶ï¼ˆç‰¹å®šä¼ è¾“å±‚åŠŸèƒ½ï¼‰

| æ–¹æ³•å        | å‚æ•° | è¿”å›å€¼            | æè¿°                    |
| ------------- | ---- | ----------------- | ----------------------- |
| `closeStream` | æ—    | `Promise<void>` | å…³é—­ SSE æµï¼ˆå¦‚æœæ”¯æŒï¼‰ |

### å®é™…ä½¿ç”¨ç¤ºä¾‹

```typescript
server.registerTool(
    'context-aware-tool',
    {
        inputSchema: {
            operation: z.string().describe('è¦æ‰§è¡Œçš„æ“ä½œ'),
        },
    },
    async ({ operation }, extra) => {
        // åŸºç¡€ä¿¡æ¯
        console.log('ä¼šè¯ID:', extra.sessionId);
        console.log('è¯·æ±‚ID:', extra.requestId);

        // è®¤è¯ä¿¡æ¯æ£€æŸ¥
        if (!extra.authInfo) {
            throw new Error('æ­¤æ“ä½œéœ€è¦è®¤è¯');
        }

        console.log('ç”¨æˆ·ID:', extra.authInfo.clientId);
        console.log('æƒé™èŒƒå›´:', extra.authInfo.scopes);

        // æ£€æŸ¥å–æ¶ˆä¿¡å·
        if (extra.signal.aborted) {
            throw new Error('æ“ä½œå·²è¢«å–æ¶ˆ');
        }

        // å‘é€è¿›åº¦é€šçŸ¥
        await extra.sendNotification({
            method: 'notifications/progress',
            params: {
                operation: 'context-aware-tool',
                progress: 0.3,
                message: 'æ­£åœ¨å¤„ç†è¯·æ±‚...',
            },
        });

        // æ‰§è¡Œæ“ä½œï¼Œéœ€è‡ªå·±å®ç° performOperation
        const result = await performOperation(operation);

        // å‘é€å®Œæˆé€šçŸ¥
        await extra.sendNotification({
            method: 'notifications/progress',
            params: {
                operation: 'context-aware-tool',
                progress: 1.0,
                message: 'æ“ä½œå®Œæˆ',
            },
        });

        return {
            content: [
                {
                    type: 'text',
                    text: `æ“ä½œ "${operation}" æ‰§è¡Œå®Œæˆ`,
                },
            ],
        };
    }
);
```

### é”™è¯¯å¤„ç†å’Œæœ€ä½³å®è·µ

```typescript
async ({ param }, extra) => {
    try {
        // 1. é¦–å…ˆæ£€æŸ¥å–æ¶ˆä¿¡å·
        if (extra.signal.aborted) {
            throw new Error('è¯·æ±‚å·²å–æ¶ˆ')
        }

        // 2. éªŒè¯è®¤è¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (requiresAuth && !extra.authInfo) {
            throw new Error('éœ€è¦è®¤è¯')
        }

        // 3. è®¾ç½®å–æ¶ˆç›‘å¬å™¨ï¼ˆå¯¹äºé•¿æ—¶é—´è¿è¡Œçš„æ“ä½œï¼‰
        const abortController = new AbortController()
        extra.signal.addEventListener('abort', () => {
            abortController.abort()
        })

        // 4. æ‰§è¡Œæ“ä½œæ—¶å®šæœŸæ£€æŸ¥å–æ¶ˆçŠ¶æ€
        for (let i = 0 i < 100 i++) {
            if (extra.signal.aborted) {
                throw new Error('æ“ä½œè¢«å–æ¶ˆ')
            }

            await processStep(i, { signal: abortController.signal })

            // å‘é€è¿›åº¦æ›´æ–°
            if (i % 10 === 0) {
                await extra.sendNotification({
                    method: 'notifications/progress',
                    params: {
                        progress: i / 100,
                        message: `å¤„ç†æ­¥éª¤ ${i}/100`,
                    },
                })
            }
        }

        return { content: [{ type: 'text', text: 'å¤„ç†å®Œæˆ' }] }
    } catch (error) {
        throw error
    }
}
```

## å·¥å…·æ³¨è§£å’Œ UI æç¤º

### Annotations é…ç½®

æ³¨è§£æä¾› UI å±‚é¢çš„é¢å¤–ä¿¡æ¯å’Œè¡Œä¸ºæç¤ºï¼š

```typescript
server.registerTool(
    'dangerous-operation',
    {
        title: 'å±é™©æ“ä½œ',
        description: 'æ‰§è¡Œå¯èƒ½å½±å“ç³»ç»Ÿçš„å±é™©æ“ä½œ',
        inputSchema: {
            operation: z
                .enum(['delete', 'reset', 'format'])
                .describe('æ“ä½œç±»å‹'),
            confirmation: z.string().describe('è¯·è¾“å…¥ "CONFIRM" ç¡®è®¤æ‰§è¡Œ'),
        },
        annotations: {
            title: 'âš ï¸ å±é™©æ“ä½œ', // è‡ªå®šä¹‰æ˜¾ç¤ºæ ‡é¢˜
            dangerousHint: true, // æ ‡è®°ä¸ºå±é™©æ“ä½œ
            readOnlyHint: false, // ä¸æ˜¯åªè¯»æ“ä½œ
            // confirmationRequired: true, // è‡ªå®šä¹‰å­—æ®µï¼Œéæ ‡å‡†æ³¨è§£å­—æ®µ
        },
    },
    async ({ operation, confirmation }, extra) => {
        if (confirmation !== 'CONFIRM') {
            throw new Error('æ“ä½œæœªç¡®è®¤ï¼Œè¯·è¾“å…¥ "CONFIRM" æ¥ç¡®è®¤æ‰§è¡Œ');
        }

        // æ‰§è¡Œå±é™©æ“ä½œ
        return {
            content: [
                {
                    type: 'text',
                    text: `å±é™©æ“ä½œ "${operation}" å·²æ‰§è¡Œ`,
                },
            ],
        };
    }
);

server.registerTool(
    'read-only-query',
    {
        title: 'åªè¯»æŸ¥è¯¢',
        description: 'æ‰§è¡Œåªè¯»çš„æ•°æ®æŸ¥è¯¢æ“ä½œ',
        inputSchema: {
            query: z.string().describe('æŸ¥è¯¢è¯­å¥'),
        },
        annotations: {
            title: 'ğŸ“– åªè¯»æŸ¥è¯¢',
            readOnlyHint: true, // æ ‡è®°ä¸ºåªè¯»æ“ä½œ
            dangerousHint: false, // ä¸æ˜¯å±é™©æ“ä½œ
            category: 'query', // å·¥å…·åˆ†ç±»
        },
    },
    async ({ query }, extra) => {
        const results = await executeReadOnlyQuery(query);
        return {
            content: [
                {
                    type: 'text',
                    text: `æŸ¥è¯¢è¿”å› ${results.length} æ¡è®°å½•`,
                },
            ],
            structuredContent: { results },
        };
    }
);
```

### å…ƒæ•°æ®(`_meta`)é…ç½®

å…ƒæ•°æ®æä¾›é¢å¤–çš„å·¥å…·ä¿¡æ¯ï¼š

```typescript
server.registerTool(
    'advanced-tool',
    {
        title: 'é«˜çº§å·¥å…·',
        description: 'å…·æœ‰ä¸°å¯Œå…ƒæ•°æ®çš„é«˜çº§å·¥å…·',
        inputSchema: {
            input: z.string().describe('è¾“å…¥æ•°æ®'),
        },
        annotations: {
            category: 'advanced',
            tags: ['utility', 'data-processing'],
        },
        _meta: {
            version: '2.1.0',
            author: 'Tool Developer',
            documentation: 'https://docs.example.com/advanced-tool',
            examples: [
                {
                    title: 'åŸºç¡€ç”¨æ³•',
                    input: { input: 'hello world' },
                    description: 'å¤„ç†ç®€å•æ–‡æœ¬',
                },
                {
                    title: 'å¤æ‚æ•°æ®',
                    input: { input: '{"key": "value"}' },
                    description: 'å¤„ç†JSONæ•°æ®',
                },
            ],
            performance: {
                averageExecutionTime: '200ms',
                memoryUsage: 'low',
                scalability: 'high',
            },
            dependencies: ['crypto', 'fs'],
            changelog: [
                {
                    version: '2.1.0',
                    changes: ['æ·»åŠ äº†JSONå¤„ç†æ”¯æŒ', 'æ€§èƒ½ä¼˜åŒ–'],
                },
                { version: '2.0.0', changes: ['é‡æ„æ ¸å¿ƒé€»è¾‘', 'æ”¹è¿›é”™è¯¯å¤„ç†'] },
            ],
        },
    },
    async ({ input }, extra) => {
        // å·¥å…·å®ç°
        return {
            content: [
                {
                    type: 'text',
                    text: `é«˜çº§å·¥å…·å¤„ç†ç»“æœï¼š${input}`,
                },
            ],
        };
    }
);
```

## é«˜çº§å·¥å…·æ¨¡å¼

### æµå¼å¤„ç†å·¥å…·

å¤„ç†å¤§é‡æ•°æ®æˆ–é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼š

```typescript
server.registerTool(
    'data-processor',
    {
        inputSchema: {
            dataSource: z.string().url().describe('æ•°æ®æºURL'),
            batchSize: z
                .number()
                .min(1)
                .max(1000)
                .default(100)
                .describe('æ‰¹å¤„ç†å¤§å°'),
            filter: z.string().optional().describe('æ•°æ®è¿‡æ»¤æ¡ä»¶'),
        },
    },
    async ({ dataSource, batchSize = 100, filter }, extra) => {
        let processedCount = 0;
        let totalCount = 0;
        const results: any[] = [];

        try {
            // è·å–æ•°æ®æµ
            const dataStream = await createDataStream(dataSource);
            totalCount = await dataStream.count();

            // æµå¼å¤„ç†
            for await (const batch of dataStream.batch(batchSize)) {
                // æ£€æŸ¥å–æ¶ˆä¿¡å·
                if (extra.signal.aborted) {
                    throw new Error('æ•°æ®å¤„ç†å·²å–æ¶ˆ');
                }

                // åº”ç”¨è¿‡æ»¤å™¨
                let filteredBatch = batch;
                if (filter) {
                    filteredBatch = batch.filter((item) =>
                        applyFilter(item, filter)
                    );
                }

                // å¤„ç†æ‰¹æ¬¡
                const processed = await processBatch(filteredBatch);
                results.push(...processed);
                processedCount += batch.length;

                // å‘é€è¿›åº¦æ›´æ–°
                const progress = Math.min(processedCount / totalCount, 1);
                await extra.sendNotification({
                    method: 'notifications/progress',
                    params: {
                        operation: 'data-processing',
                        progress,
                        message: `å·²å¤„ç† ${processedCount}/${totalCount} æ¡è®°å½•`,
                        details: {
                            batchesCompleted: Math.ceil(
                                processedCount / batchSize
                            ),
                            currentBatchSize: filteredBatch.length,
                        },
                    },
                });

                // æ¯å¾ªç¯å®Œä¸€æ¬¡å°±ç©¿æ’ä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ¥é¿å…é˜»å¡äº‹ä»¶å¾ªç¯
                await new Promise((resolve) => setImmediate(resolve));
            }

            return {
                content: [
                    {
                        type: 'text',
                        text: `æ•°æ®å¤„ç†å®Œæˆï¼\n- æ€»è®°å½•æ•°ï¼š${totalCount}\n- å¤„ç†è®°å½•æ•°ï¼š${processedCount}\n- ç»“æœè®°å½•æ•°ï¼š${results.length}`,
                    },
                ],
                structuredContent: {
                    summary: {
                        totalRecords: totalCount,
                        processedRecords: processedCount,
                        resultRecords: results.length,
                        batchSize,
                        filter,
                    },
                    results: results.slice(0, 10), // åªè¿”å›å‰10æ¡ä½œä¸ºé¢„è§ˆ
                    hasMore: results.length > 10,
                },
            };
        } catch (error) {
            // å‘é€é”™è¯¯é€šçŸ¥
            await extra.sendNotification({
                method: 'notifications/error',
                params: {
                    operation: 'data-processing',
                    message: `æ•°æ®å¤„ç†å¤±è´¥ï¼š${error.message}`,
                    details: {
                        processedCount,
                        totalCount,
                    },
                },
            });

            throw error;
        }
    }
);
```

### äº¤äº’å¼å·¥å…·

éœ€è¦å¤šæ­¥éª¤ç”¨æˆ·äº¤äº’çš„å·¥å…·ï¼š

```typescript
server.registerTool(
    'interactive-setup',
    {
        inputSchema: {
            setupType: z
                .enum(['database', 'api', 'storage'])
                .describe('è®¾ç½®ç±»å‹'),
            skipInteraction: z
                .boolean()
                .default(false)
                .describe('è·³è¿‡äº¤äº’ï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰'),
        },
    },
    async ({ setupType, skipInteraction }, extra) => {
        const steps: any[] = []
        let currentConfig: any = {}

        try {
            // æ­¥éª¤1ï¼šåŸºç¡€é…ç½®
            if (!skipInteraction) {
                const basicConfigResult = await extra.sendRequest(
                    {
                        method: 'elicitation/create',
                        params: {
                            mode: 'form',
                            message: `è¯·é…ç½®${setupType}çš„åŸºç¡€ä¿¡æ¯`,
                            requestedSchema: getBasicConfigSchema(setupType),
                        },
                    },
                    ElicitationCreateRequestSchema
                )

                if (basicConfigResult.action !== 'accept') {
                    return { content: [{ type: 'text', text: 'è®¾ç½®å·²å–æ¶ˆ' }] }
                }

                currentConfig = {
                    ...currentConfig,
                    ...basicConfigResult.content,
                }
                steps.push({
                    step: 'basic',
                    config: basicConfigResult.content,
                })
            }

            // æ­¥éª¤2ï¼šé«˜çº§é…ç½®
            if (!skipInteraction) {
                const advancedConfigResult = await extra.sendRequest(
                    {
                        method: 'elicitation/create',
                        params: {
                            mode: 'form',
                            message: 'è¯·é…ç½®é«˜çº§é€‰é¡¹',
                            requestedSchema: getAdvancedConfigSchema(
                                setupType,
                                currentConfig
                            ),
                        },
                    },
                    ElicitationCreateRequestSchema
                )

                if (advancedConfigResult.action === 'accept') {
                    currentConfig = {
                        ...currentConfig,
                        ...advancedConfigResult.content,
                    }
                    steps.push({
                        step: 'advanced',
                        config: advancedConfigResult.content,
                    })
                }
            }

            // æ­¥éª¤3ï¼šæµ‹è¯•è¿æ¥
            await extra.sendNotification({
                method: 'notifications/progress',
                params: {
                    operation: 'setup',
                    progress: 0.7,
                    message: 'æ­£åœ¨æµ‹è¯•è¿æ¥...',
                },
            })

            const testResult = await testConnection(setupType, currentConfig)
            steps.push({ step: 'test', result: testResult })

            if (!testResult.success) {
                return {
                    content: [
                        {
                            type: 'text',
                            text: `è¿æ¥æµ‹è¯•å¤±è´¥ï¼š${testResult.error}\nè¯·æ£€æŸ¥é…ç½®å¹¶é‡è¯•ã€‚`,
                        },
                    ],
                    structuredContent: {
                        success: false,
                        steps,
                        error: testResult.error,
                    },
                }
            }

            // æ­¥éª¤4ï¼šä¿å­˜é…ç½®
            await saveConfiguration(setupType, currentConfig)
            steps.push({ step: 'save', success: true })

            return {
                content: [
                    {
                        type: 'text',
                        text: `${setupType}è®¾ç½®å®Œæˆï¼\né…ç½®å·²ä¿å­˜å¹¶æµ‹è¯•é€šè¿‡ã€‚`,
                    },
                ],
                structuredContent: {
                    success: true,
                    setupType,
                    steps,
                    finalConfig: currentConfig,
                },
            }
        } catch (error) {
            steps.push({ step: 'error', error: error.message })

            return {
                content: [
                    {
                        type: 'text',
                        text: `è®¾ç½®è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š${error.message}`,
                    },
                ],
                structuredContent: {
                    success: false,
                    steps,
                    error: error.message,
                },
            }
        }
    }
)

// è¾…åŠ©å‡½æ•°
function getBasicConfigSchema(type: string) {
    const schemas = {
        database: {
            type: 'object',
            properties: {
                host: {
                    type: 'string',
                    title: 'æ•°æ®åº“ä¸»æœº',
                    default: 'localhost',
                },
                port: { type: 'number', title: 'ç«¯å£', default: 5432 },
                database: { type: 'string', title: 'æ•°æ®åº“å' },
                username: { type: 'string', title: 'ç”¨æˆ·å' },
                password: { type: 'string', title: 'å¯†ç ', format: 'password' },
            },
            required: ['database', 'username', 'password'],
        },
        api: {
            type: 'object',
            properties: {
                baseUrl: { type: 'string', title: 'APIåŸºç¡€URL', format: 'uri' },
                apiKey: {
                    type: 'string',
                    title: 'APIå¯†é’¥',
                    format: 'password',
                },
                version: { type: 'string', title: 'APIç‰ˆæœ¬', default: 'v1' },
            },
            required: ['baseUrl', 'apiKey'],
        },
        storage: {
            type: 'object',
            properties: {
                provider: {
                    type: 'string',
                    enum: ['aws', 'azure', 'gcp'],
                    title: 'äº‘æœåŠ¡æä¾›å•†',
                },
                region: { type: 'string', title: 'åŒºåŸŸ' },
                bucket: { type: 'string', title: 'å­˜å‚¨æ¡¶åç§°' },
                accessKey: { type: 'string', title: 'è®¿é—®å¯†é’¥' },
                secretKey: {
                    type: 'string',
                    title: 'å¯†é’¥',
                    format: 'password',
                },
            },
            required: [
                'provider',
                'region',
                'bucket',
                'accessKey',
                'secretKey',
            ],
        },
    }

    return schemas[type] || {}
}

function getAdvancedConfigSchema(type: string, basicConfig: any) {
    const schemas = {
        database: {
            type: 'object',
            properties: {
                ssl: { type: 'boolean', title: 'å¯ç”¨SSL', default: true },
                poolSize: {
                    type: 'number',
                    title: 'è¿æ¥æ± å¤§å°',
                    default: 10,
                    minimum: 1,
                    maximum: 100,
                },
                timeout: {
                    type: 'number',
                    title: 'è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰',
                    default: 30,
                },
            },
        },
        api: {
            type: 'object',
            properties: {
                timeout: {
                    type: 'number',
                    title: 'è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰',
                    default: 5000,
                },
                retries: { type: 'number', title: 'é‡è¯•æ¬¡æ•°', default: 3 },
                rateLimit: {
                    type: 'number',
                    title: 'é€Ÿç‡é™åˆ¶ï¼ˆè¯·æ±‚/ç§’ï¼‰',
                    default: 100,
                },
            },
        },
        storage: {
            type: 'object',
            properties: {
                encryption: {
                    type: 'boolean',
                    title: 'å¯ç”¨åŠ å¯†',
                    default: true,
                },
                versioning: {
                    type: 'boolean',
                    title: 'å¯ç”¨ç‰ˆæœ¬æ§åˆ¶',
                    default: false,
                },
                lifecycle: {
                    type: 'number',
                    title: 'ç”Ÿå‘½å‘¨æœŸï¼ˆå¤©ï¼‰',
                    default: 30,
                },
            },
        },
    }

    return schemas[type] || {}
}

async function testConnection(
    type: string,
    config: any
): Promise<{ success: boolean error?: string }> {
    try {
        switch (type) {
            case 'database':
                // æµ‹è¯•æ•°æ®åº“è¿æ¥
                await testDatabaseConnection(config)
                break
            case 'api':
                // æµ‹è¯•APIè¿æ¥
                await testApiConnection(config)
                break
            case 'storage':
                // æµ‹è¯•å­˜å‚¨è¿æ¥
                await testStorageConnection(config)
                break
        }
        return { success: true }
    } catch (error) {
        return { success: false, error: error.message }
    }
}
```
