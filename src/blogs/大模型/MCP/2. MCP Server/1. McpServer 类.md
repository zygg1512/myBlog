# McpServer ç±»

McpServer æ˜¯ `@modelcontextprotocol/server` åŒ…æä¾›çš„é«˜çº§ API ç±»ï¼Œç”¨äºåˆ›å»º MCP (Model Context Protocol) æœåŠ¡å™¨ã€‚å®ƒå°è£…äº†åº•å±‚çš„ Server ç±»ï¼Œæä¾›äº†ç®€åŒ–çš„æ¥å£æ¥æ³¨å†Œå·¥å…·ã€èµ„æºå’Œæç¤ºï¼ŒåŒæ—¶æ”¯æŒåŒå‘é€šä¿¡å’Œå®éªŒæ€§åŠŸèƒ½ã€‚

## æ„é€ å‡½æ•°

### è¯­æ³•

```typescript
new McpServer(serverInfo: Implementation, options?: ServerOptions)
```

### å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| `serverInfo` | `Implementation` | æ˜¯ | æœåŠ¡å™¨çš„åŸºæœ¬ä¿¡æ¯é…ç½®ï¼Œç”¨äºæ ‡è¯†å’Œæè¿°æœåŠ¡å™¨å®ä¾‹ |
| `options` | `ServerOptions` | å¦ | æœåŠ¡å™¨çš„é«˜çº§é…ç½®é€‰é¡¹ï¼Œç”¨äºå®šåˆ¶æœåŠ¡å™¨è¡Œä¸ºå’Œèƒ½åŠ› |

**`serverInfo` (`Implementation`) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| `name` | `string` | æ˜¯ | æœåŠ¡å™¨åç§°ï¼Œç”¨äºæ ‡è¯†æœåŠ¡å™¨ï¼Œå»ºè®®ä½¿ç”¨å°å†™å­—æ¯å’Œè¿å­—ç¬¦ |
| `version` | `string` | æ˜¯ | è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œå¦‚ "1.0.0" |
| `description` | `string` | å¦ | æœåŠ¡å™¨æè¿°ï¼Œå‘å®¢æˆ·ç«¯è¯´æ˜æœåŠ¡å™¨åŠŸèƒ½ |
| `websiteUrl` | `string` | å¦ | å®˜ç½‘æˆ–æ–‡æ¡£URLï¼Œæä¾›æ›´å¤šä¿¡æ¯ |
| `icons` | `Icon[]` | å¦ | å›¾æ ‡æ•°ç»„ï¼Œç”¨äºåœ¨å®¢æˆ·ç«¯UIä¸­æ˜¾ç¤º |

**`icons` (`Icon[]`) æ•°ç»„å…ƒç´ å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
| `url` | `string` | æ˜¯ | å›¾æ ‡çš„å®Œæ•´URLåœ°å€ |
| `type` | `string` | æ˜¯ | MIMEç±»å‹ï¼Œå¸¸è§å€¼ï¼š'image/png', 'image/svg+xml', 'image/jpeg' |
| `size` | `number` | å¦ | å›¾æ ‡å°ºå¯¸ï¼ˆåƒç´ ï¼‰ï¼Œå»ºè®®ä½¿ç”¨ 16, 32, 48, 64, 128 ç­‰æ ‡å‡†å°ºå¯¸ |

**options (ServerOptions) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`capabilities`|`ServerCapabilities`| å¦ | æœåŠ¡å™¨èƒ½åŠ›å£°æ˜ï¼Œå®šä¹‰æœåŠ¡å™¨æ”¯æŒçš„åŠŸèƒ½ |
|`instructions`|`string`| å¦ | ä½¿ç”¨è¯´æ˜ï¼Œå‘å®¢æˆ·ç«¯æä¾›æ“ä½œæŒ‡å¯¼ |
|`jsonSchemaValidator`|`JsonSchemaValidator`| å¦ | è‡ªå®šä¹‰JSON SchemaéªŒè¯å™¨å®ç° |

**capabilities (ServerCapabilities) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`tools`|`object`| å¦ | å·¥å…·ç›¸å…³èƒ½åŠ›é…ç½® |
|`tools.listChanged`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥ï¼Œtrueæ—¶å¯å‘é€å·¥å…·åˆ—è¡¨æ›´æ–°é€šçŸ¥ |
|`resources`|`object`| å¦ | èµ„æºç›¸å…³èƒ½åŠ›é…ç½® |
|`resources.listChanged`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒèµ„æºåˆ—è¡¨å˜æ›´é€šçŸ¥ï¼Œtrueæ—¶å¯å‘é€èµ„æºåˆ—è¡¨æ›´æ–°é€šçŸ¥ |
|`resources.subscribe`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒèµ„æºè®¢é˜…ï¼Œtrueæ—¶å®¢æˆ·ç«¯å¯è®¢é˜…ç‰¹å®šèµ„æºçš„å˜æ›´ |
|`prompts`|`object`| å¦ | æç¤ºç›¸å…³èƒ½åŠ›é…ç½® |
|`prompts.listChanged`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒæç¤ºåˆ—è¡¨å˜æ›´é€šçŸ¥ï¼Œtrueæ—¶å¯å‘é€æç¤ºæ¨¡æ¿åˆ—è¡¨æ›´æ–°é€šçŸ¥ |
|`logging`|`object`| å¦ | æ—¥å¿—åŠŸèƒ½æ”¯æŒï¼Œç©ºå¯¹è±¡è¡¨ç¤ºæ”¯æŒåŸºæœ¬æ—¥å¿—åŠŸèƒ½ |
|`completions`|`object`| å¦ | è‡ªåŠ¨è¡¥å…¨ç›¸å…³èƒ½åŠ›é…ç½® |
|`completions.tools`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒå·¥å…·å‚æ•°è‡ªåŠ¨è¡¥å…¨ï¼Œtrueæ—¶å®¢æˆ·ç«¯å¯è¯·æ±‚å·¥å…·å‚æ•°å»ºè®® |
|`completions.resources`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒèµ„æºURIè‡ªåŠ¨è¡¥å…¨ï¼Œtrueæ—¶å®¢æˆ·ç«¯å¯è¯·æ±‚èµ„æºURIå»ºè®® |
|`completions.prompts`|`boolean`| å¦ | æ˜¯å¦æ”¯æŒæç¤ºå‚æ•°è‡ªåŠ¨è¡¥å…¨ï¼Œtrueæ—¶å®¢æˆ·ç«¯å¯è¯·æ±‚æç¤ºå‚æ•°å»ºè®® |
|`tasks`|`object`| å¦ | å®éªŒæ€§ä»»åŠ¡åŠŸèƒ½æ”¯æŒ |
|`tasks.requests`|`object`| å¦ | ä»»åŠ¡è¯·æ±‚ç›¸å…³é…ç½® |
|`tasks.requests.tools`|`object`| å¦ | å·¥å…·è°ƒç”¨ä»»åŠ¡é…ç½® |
|`tasks.requests.tools.call`|`object`| å¦ | æ˜¯å¦æ”¯æŒå·¥å…·è°ƒç”¨ä»»åŠ¡ï¼Œç©ºå¯¹è±¡è¡¨ç¤ºæ”¯æŒåŸºæœ¬å·¥å…·è°ƒç”¨ä»»åŠ¡ |

**jsonSchemaValidator (JsonSchemaValidator) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`validate`|`function`| æ˜¯ | éªŒè¯æ•°æ®æ˜¯å¦ç¬¦åˆæŒ‡å®šçš„JSON Schemaçš„å‡½æ•° |

**validate å‡½æ•°ç­¾åï¼š**
```typescript
validate(schema: object, data: any): boolean
```

### ç¤ºä¾‹

```typescript
import { McpServer } from '@modelcontextprotocol/server';

// åŸºæœ¬åˆå§‹åŒ–
const server = new McpServer({
    name: 'my-mcp-server',
    version: '1.0.0',
    description: 'æˆ‘çš„MCPæœåŠ¡å™¨',
});

// å®Œæ•´é…ç½®åˆå§‹åŒ–
const server = new McpServer(
    {
        name: 'advanced-mcp-server',
        version: '2.0.0',
        description: 'é«˜çº§MCPæœåŠ¡å™¨',
        websiteUrl: 'https://example.com',
        icons: [
            {
                url: 'https://example.com/icon.png',
                type: 'image/png',
                size: 32,
            },
        ],
    },
    {
        capabilities: {
            tools: { listChanged: true },
            resources: { listChanged: true, subscribe: true },
            prompts: { listChanged: true },
            logging: {},
            completions: {
                tools: true,
                resources: true,
                prompts: true,
            },
        },
        instructions: 'è¿™æ˜¯ä¸€ä¸ªæä¾›æ–‡ä»¶æ“ä½œå’Œæ•°æ®åˆ†æåŠŸèƒ½çš„æœåŠ¡å™¨ã€‚',
    }
);
```

## å®ä¾‹å±æ€§

### server

åªè¯»å±æ€§ï¼Œæä¾›å¯¹åº•å±‚ `Server` å®ä¾‹çš„ç›´æ¥è®¿é—®ã€‚

```typescript
public readonly server: Server
```

**ç±»å‹**

| ç±»å‹ | æè¿° |
|------|------|
|`Server`| åº•å±‚çš„ Server å®ä¾‹ï¼Œæä¾›å®Œæ•´çš„åè®®æ§åˆ¶åŠŸèƒ½ |

**ç”¨é€”**

- è®¿é—®åº•å±‚åè®®åŠŸèƒ½
- è®¾ç½®è‡ªå®šä¹‰è¯·æ±‚å¤„ç†å™¨
- ä½¿ç”¨é«˜çº§é€šä¿¡åŠŸèƒ½

**ç¤ºä¾‹**ï¼š

```typescript
// è®¿é—®åº•å±‚Serverå®ä¾‹
const underlyingServer = mcpServer.server;

// è·å–å®¢æˆ·ç«¯èƒ½åŠ›
const clientCaps = underlyingServer.getClientCapabilities();

// å‘é€æœåŠ¡å™¨å‘èµ·çš„è¯·æ±‚
const response = await underlyingServer.createMessage({
    messages: [{ role: 'user', content: { type: 'text', text: 'è¯·åˆ†ææ•°æ®' } }],
    maxTokens: 1000,
});

// è®¾ç½®è‡ªå®šä¹‰è¯·æ±‚å¤„ç†å™¨
import { CallToolRequestSchema } from '@modelcontextprotocol/core';
underlyingServer.setRequestHandler(
    CallToolRequestSchema,
    async (request, extra) => {
        // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        return { content: [{ type: 'text', text: 'è‡ªå®šä¹‰å“åº”' }] };
    }
);
```

## è¿æ¥ç®¡ç†

### connect()

è¿æ¥åˆ°æŒ‡å®šçš„ä¼ è¾“å±‚å¹¶å¯åŠ¨æœåŠ¡å™¨ã€‚

```typescript
connect(transport: Transport): Promise<void>
```

**å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`transport`|`Transport`| æ˜¯ | ä¼ è¾“å±‚å®ä¾‹ï¼Œå®šä¹‰äº†æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„é€šä¿¡æ–¹å¼ |

**transport (Transport) å¯é€‰ç±»å‹ï¼š**

| ä¼ è¾“å±‚ç±»å‹ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ | é…ç½®å‚æ•° |
|-----------|---------|------|----------|
|`StreamableHTTPServerTransport`| è¿œç¨‹HTTPæœåŠ¡ | æ”¯æŒSSEæµå¼ä¼ è¾“ï¼Œé€‚åˆWebåº”ç”¨é›†æˆ | sessionIdGenerator, port, host |
|`StdioServerTransport`| æœ¬åœ°è¿›ç¨‹é€šä¿¡ | é€šè¿‡æ ‡å‡†è¾“å…¥è¾“å‡ºé€šä¿¡ï¼Œé€‚åˆå‘½ä»¤è¡Œå·¥å…· | æ— éœ€é…ç½®å‚æ•° |
|`SSEServerTransport`| ä¼ ç»ŸHTTP+SSE | å…¼å®¹æ—§ç‰ˆå®¢æˆ·ç«¯çš„HTTPä¼ è¾“æ–¹å¼ | port, host ç­‰HTTPé…ç½® |

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
| `Promise<void>` | å¼‚æ­¥æ“ä½œPromiseï¼Œè¿æ¥æˆåŠŸæ—¶resolveï¼Œå¤±è´¥æ—¶rejectå¹¶æŠ›å‡ºé”™è¯¯ä¿¡æ¯ |

**ç¤ºä¾‹**ï¼š

```typescript
import { StreamableHTTPServerTransport } from '@modelcontextprotocol/server/streamable-http';
import { StdioServerTransport } from '@modelcontextprotocol/server/stdio';

// HTTPä¼ è¾“
const httpTransport = new StreamableHTTPServerTransport({
    sessionIdGenerator: () => crypto.randomUUID(),
});
await server.connect(httpTransport);

// æ ‡å‡†è¾“å…¥è¾“å‡ºä¼ è¾“
const stdioTransport = new StdioServerTransport();
await server.connect(stdioTransport);
```

### close()

ä¼˜é›…åœ°å…³é—­æœåŠ¡å™¨è¿æ¥ï¼Œæ¸…ç†èµ„æºå¹¶åœæ­¢æ‰€æœ‰æ´»åŠ¨çš„é€šä¿¡ã€‚

```typescript
close(): Promise<void>
```

**å‚æ•°**

æ­¤æ–¹æ³•æ— éœ€å‚æ•°ã€‚

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
| `Promise<void>` | å¼‚æ­¥æ“ä½œPromiseï¼Œå…³é—­å®Œæˆæ—¶resolveï¼Œå¤±è´¥æ—¶rejectå¹¶æŠ›å‡ºé”™è¯¯ä¿¡æ¯ |

**æ³¨æ„äº‹é¡¹**

- è°ƒç”¨åæœåŠ¡å™¨å°†æ— æ³•æ¥å—æ–°çš„è¿æ¥
- æ­£åœ¨å¤„ç†çš„è¯·æ±‚ä¼šç­‰å¾…å®Œæˆ
- å»ºè®®åœ¨è¿›ç¨‹é€€å‡ºå‰è°ƒç”¨æ­¤æ–¹æ³•

**ç¤ºä¾‹**ï¼š

```typescript
// ä¼˜é›…å…³é—­
async function shutdown() {
    try {
        await server.close();
        console.log('æœåŠ¡å™¨å·²å…³é—­');
    } catch (error) {
        console.error('å…³é—­å¤±è´¥:', error);
    }
}

// å¤„ç†è¿›ç¨‹ä¿¡å·
process.on('SIGINT', shutdown);
process.on('SIGTERM', shutdown);
```

### isConnected()

æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å·²è¿æ¥ã€‚

```typescript
isConnected(): boolean
```

**å‚æ•°**

æ­¤æ–¹æ³•æ— éœ€å‚æ•°ã€‚

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
|`boolean`| è¿æ¥çŠ¶æ€ï¼Œtrueè¡¨ç¤ºå·²è¿æ¥ï¼Œfalseè¡¨ç¤ºæœªè¿æ¥ |

**ç¤ºä¾‹**ï¼š

```typescript
if (server.isConnected()) {
    console.log('æœåŠ¡å™¨å·²è¿æ¥');
    server.sendToolListChanged();
} else {
    console.log('æœåŠ¡å™¨æœªè¿æ¥');
}
```

## å·¥å…·ç®¡ç†

### registerTool()

æ³¨å†Œä¸€ä¸ªå·¥å…·ï¼Œä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚

```typescript
registerTool(name: string, config: ToolRegistrationConfig, handler: ToolCallback): RegisteredTool
```

**å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`name`|`string`| æ˜¯ | å·¥å…·åç§°ï¼Œå¿…é¡»å”¯ä¸€ |
|`config`|`ToolRegistrationConfig`| æ˜¯ | å·¥å…·é…ç½®ä¿¡æ¯ |
|`handler`|`ToolCallback`| æ˜¯ | å·¥å…·å¤„ç†å‡½æ•° |

**config (ToolRegistrationConfig) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`description`|`string`| æ˜¯ | å·¥å…·æè¿°ï¼Œè¯´æ˜å·¥å…·çš„åŠŸèƒ½ |
|`inputSchema`|`object`| æ˜¯ | è¾“å…¥å‚æ•°çš„JSON Schemaå®šä¹‰ |

**handler (ToolCallback) å‡½æ•°ç­¾åï¼š**
```typescript
type ToolCallback = (args: any, extra: RequestHandlerExtra) => CallToolResult | Promise<CallToolResult>
```

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
|`RegisteredTool`| æ³¨å†Œçš„å·¥å…·å¯¹è±¡ï¼Œå¯ç”¨äºåç»­çš„æ›´æ–°ã€å¯ç”¨/ç¦ç”¨ç­‰æ“ä½œ |

## èµ„æºç®¡ç†

### registerResource()

æ³¨å†Œä¸€ä¸ªèµ„æºï¼Œä¾›å®¢æˆ·ç«¯è®¿é—®ã€‚

```typescript
registerResource(name: string, config: ResourceMetadata, handler: ReadResourceCallback): RegisteredResource
```

**å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`name`|`string`| æ˜¯ | èµ„æºåç§°ï¼Œå¿…é¡»å”¯ä¸€ |
|`config`|`ResourceMetadata`| æ˜¯ | èµ„æºé…ç½®ä¿¡æ¯ |
|`handler`|`ReadResourceCallback`| æ˜¯ | èµ„æºå¤„ç†å‡½æ•° |

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
|`RegisteredResource`| æ³¨å†Œçš„èµ„æºå¯¹è±¡ï¼Œå¯ç”¨äºåç»­çš„æ›´æ–°ã€å¯ç”¨/ç¦ç”¨ç­‰æ“ä½œ |

## æç¤ºç®¡ç†

### registerPrompt()

æ³¨å†Œä¸€ä¸ªæç¤ºæ¨¡æ¿ï¼Œä¾›å®¢æˆ·ç«¯ä½¿ç”¨ã€‚

```typescript
registerPrompt(name: string, config: PromptRegistrationConfig, handler: PromptCallback): RegisteredPrompt
```

**å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`name`|`string`| æ˜¯ | æç¤ºåç§°ï¼Œå¿…é¡»å”¯ä¸€ |
|`config`|`PromptRegistrationConfig`| æ˜¯ | æç¤ºé…ç½®ä¿¡æ¯ |
|`handler`|`PromptCallback`| æ˜¯ | æç¤ºå¤„ç†å‡½æ•° |

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
|`RegisteredPrompt`| æ³¨å†Œçš„æç¤ºå¯¹è±¡ï¼Œå¯ç”¨äºåç»­çš„æ›´æ–°ã€å¯ç”¨/ç¦ç”¨ç­‰æ“ä½œ |

## æ—¥å¿—å’Œé€šçŸ¥

### åˆ—è¡¨å˜æ›´é€šçŸ¥æ–¹æ³•

è¿™äº›æ–¹æ³•ç”¨äºå‘å®¢æˆ·ç«¯å‘é€å„ç§åˆ—è¡¨å˜æ›´çš„é€šçŸ¥ï¼Œè®©å®¢æˆ·ç«¯èƒ½å¤ŸåŠæ—¶æ›´æ–°å…¶ç¼“å­˜çš„åˆ—è¡¨ä¿¡æ¯ã€‚

- `sendResourceListChanged()`ï¼šé€šçŸ¥å®¢æˆ·ç«¯èµ„æºåˆ—è¡¨å·²å˜æ›´ã€‚
- `sendToolListChanged()`ï¼šé€šçŸ¥å®¢æˆ·ç«¯å·¥å…·åˆ—è¡¨å·²å˜æ›´ã€‚
- `sendPromptListChanged()`ï¼šé€šçŸ¥å®¢æˆ·ç«¯æç¤ºåˆ—è¡¨å·²å˜æ›´ã€‚

#### æ³¨æ„

1. è¿™äº›æ–¹æ³•åœ¨æ³¨å†Œã€æ›´æ–°ã€åˆ é™¤æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚

```typescript
// è¿™äº›æ“ä½œä¼šè‡ªåŠ¨è§¦å‘ç›¸åº”çš„åˆ—è¡¨å˜æ›´é€šçŸ¥
server.registerTool('new-tool', {...}, handler)       // è‡ªåŠ¨è°ƒç”¨ sendToolListChanged()
server.registerResource('new-resource', {...}, handler) // è‡ªåŠ¨è°ƒç”¨ sendResourceListChanged()
server.registerPrompt('new-prompt', {...}, handler)     // è‡ªåŠ¨è°ƒç”¨ sendPromptListChanged()

// æ›´æ–°å’Œåˆ é™¤æ“ä½œä¹Ÿä¼šè‡ªåŠ¨è§¦å‘é€šçŸ¥
registeredTool.update({...})            // è‡ªåŠ¨è°ƒç”¨ sendToolListChanged()
registeredResource.remove()             // è‡ªåŠ¨è°ƒç”¨ sendResourceListChanged()
registeredPrompt.disable()              // è‡ªåŠ¨è°ƒç”¨ sendPromptListChanged()
```

2. ä½¿ç”¨å‰å¿…é¡»åœ¨åˆå§‹åŒ–æ—¶å£°æ˜ prompts èƒ½åŠ›ï¼š

```typescript
capabilities: {
    prompts: {
        listChanged: true;
    }
}
```

#### ç¤ºä¾‹

```typescript
// âœ… æ­£ç¡®çš„å®Œæ•´é…ç½®
const server = new McpServer(
    {
        name: 'notification-server',
        version: '1.0.0',
    },
    {
        capabilities: {
            tools: { listChanged: true }, // æ”¯æŒå·¥å…·åˆ—è¡¨å˜æ›´é€šçŸ¥
            resources: { listChanged: true }, // æ”¯æŒèµ„æºåˆ—è¡¨å˜æ›´é€šçŸ¥
            prompts: { listChanged: true }, // æ”¯æŒæç¤ºåˆ—è¡¨å˜æ›´é€šçŸ¥
            logging: {},
        },
    }
);

// è¿æ¥ä¼ è¾“å±‚
await server.connect(transport);

// æ‰‹åŠ¨å‘é€å˜æ›´é€šçŸ¥
server.sendResourceListChanged(); // é€šçŸ¥èµ„æºåˆ—è¡¨å˜æ›´
server.sendToolListChanged(); // é€šçŸ¥å·¥å…·åˆ—è¡¨å˜æ›´
server.sendPromptListChanged(); // é€šçŸ¥æç¤ºåˆ—è¡¨å˜æ›´
```

### sendLoggingMessage()

å‘è¿æ¥çš„å®¢æˆ·ç«¯å‘é€æ—¥å¿—æ¶ˆæ¯ï¼Œç”¨äºå®æ—¶ä¼ è¾“æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶æ€ã€é”™è¯¯ä¿¡æ¯å’Œè°ƒè¯•æ•°æ®ã€‚

```typescript
sendLoggingMessage(params: LoggingMessageNotification['params'], sessionId?: string): Promise<void>
```

**å‚æ•°**

| å‚æ•°å | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`params`|`LoggingMessageNotification['params']`| æ˜¯ | æ—¥å¿—æ¶ˆæ¯çš„å…·ä½“å†…å®¹å’Œé…ç½® |
|`sessionId`|`string`| å¦ | ç›®æ ‡ä¼šè¯çš„æ ‡è¯†ç¬¦ï¼Œç”¨äºå‘ç‰¹å®šå®¢æˆ·ç«¯ä¼šè¯å‘é€æ—¥å¿— |

**params (LoggingMessageNotification['params']) è¯¦ç»†å­—æ®µï¼š**

| å­—æ®µå | ç±»å‹ | å¿…å¡« | æè¿° |
|--------|------|------|------|
|`level`|`LoggingLevel`| æ˜¯ | æ—¥å¿—çº§åˆ«ï¼Œç”¨äºåˆ†ç±»å’Œè¿‡æ»¤ |
|`logger`|`string`| å¦ | æ—¥å¿—æ¥æºæ ‡è¯†ï¼Œå¯é€‰çš„æ¨¡å—æˆ–ç»„ä»¶åç§° |
|`data`|`any`| æ˜¯ | æ—¥å¿—æ•°æ®ï¼Œå¯ä»¥æ˜¯ä»»æ„ç»“æ„çš„æ•°æ® |

**level (LoggingLevel) å¯é€‰å€¼ï¼š**

| çº§åˆ« | ç”¨é€” | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
|`debug`| è°ƒè¯•ä¿¡æ¯ | å¼€å‘é˜¶æ®µçš„è¯¦ç»†æ‰§è¡Œæµç¨‹ |
|`info`| ä¸€èˆ¬ä¿¡æ¯ | æ­£å¸¸çš„ä¸šåŠ¡æ“ä½œè®°å½• |
|`notice`| é‡è¦é€šçŸ¥ | éœ€è¦æ³¨æ„ä½†éé”™è¯¯çš„äº‹ä»¶ |
|`warning`| è­¦å‘Šä¿¡æ¯ | æ½œåœ¨é—®é¢˜æˆ–å¼‚å¸¸æƒ…å†µ |
|`error`| é”™è¯¯ä¿¡æ¯ | å¤„ç†å¤±è´¥ä½†å¯æ¢å¤çš„é”™è¯¯ |
|`critical`| ä¸¥é‡é”™è¯¯ | å½±å“åŠŸèƒ½çš„ä¸¥é‡é—®é¢˜ |
|`alert`| ç´§æ€¥è­¦æŠ¥ | éœ€è¦ç«‹å³å¤„ç†çš„é—®é¢˜ |
|`emergency`| ç³»ç»Ÿå´©æºƒ | ç³»ç»Ÿä¸å¯ç”¨çš„ç´§æ€¥æƒ…å†µ |

**è¿”å›å€¼**

| ç±»å‹ | æè¿° |
|------|------|
| `Promise<void>`| å¼‚æ­¥æ“ä½œPromiseï¼Œæ—¥å¿—å‘é€æˆåŠŸæ—¶resolveï¼Œå¤±è´¥æ—¶reject |

**ä½¿ç”¨å‰ææ¡ä»¶**

- æœåŠ¡å™¨å¿…é¡»åœ¨åˆå§‹åŒ–æ—¶å£°æ˜`logging`èƒ½åŠ›
- å®¢æˆ·ç«¯å¿…é¡»æ”¯æŒæ—¥å¿—æ¥æ”¶åŠŸèƒ½

#### ç¤ºä¾‹

```typescript
// âœ… æ­£ç¡®çš„å®Œæ•´é…ç½®
const server = new McpServer(
    {
        name: 'logging-server',
        version: '1.0.0',
    },
    {
        capabilities: {
            logging: {}, // å…³é”®ï¼šå£°æ˜æ—¥å¿—èƒ½åŠ›
            tools: { listChanged: true },
        },
    }
);

// è¿æ¥ä¼ è¾“å±‚
await server.connect(transport);

// å‘é€ä¿¡æ¯æ—¥å¿—
await server.sendLoggingMessage({
    level: 'info',
    logger: 'MyApp',
    data: {
        message: 'ç”¨æˆ·ç™»å½•æˆåŠŸ',
        userId: '12345',
        timestamp: new Date().toISOString(),
    },
});

// å‘é€é”™è¯¯æ—¥å¿—
await server.sendLoggingMessage({
    level: 'error',
    data: {
        message: 'æ•°æ®åº“è¿æ¥å¤±è´¥',
        error: error.message,
        stack: error.stack,
    },
});

// ä¼šè¯ç‰¹å®šæ—¥å¿—
await server.sendLoggingMessage(
    {
        level: 'warning',
        data: { message: 'ä¼šè¯å³å°†è¿‡æœŸ' },
    },
    'session-123'
);
```

## å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ MCP æœåŠ¡å™¨ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åˆ›å»ºæœåŠ¡å™¨ã€æ³¨å†Œå·¥å…·ã€èµ„æºå’Œæç¤ºï¼Œä»¥åŠå¦‚ä½•å¤„ç†è¿æ¥å’Œæ—¥å¿—è®°å½•ã€‚ç¤ºä¾‹ä¸­åŒ…å«äº†è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šï¼Œæ–¹ä¾¿ç†è§£æ¯ä¸€æ­¥çš„æ“ä½œã€‚

```typescript
import { McpServer } from '@modelcontextprotocol/server';
import { StreamableHTTPServerTransport } from '@modelcontextprotocol/server/streamable-http';
import { z } from 'zod';
import fs from 'fs/promises';

// åˆ›å»ºæœåŠ¡å™¨
const server = new McpServer(
    {
        name: 'file-manager-server',
        version: '1.0.0',
        description: 'æ–‡ä»¶ç®¡ç†MCPæœåŠ¡å™¨',
    },
    {
        capabilities: {
            tools: { listChanged: true },
            resources: { listChanged: true },
            prompts: { listChanged: true }, // æ”¯æŒæç¤ºåˆ—è¡¨å˜æ›´é€šçŸ¥
            logging: {}, // æ”¯æŒæ—¥å¿—åŠŸèƒ½
        },
    }
);

// æ³¨å†Œæ–‡ä»¶è¯»å–å·¥å…·
server.registerTool(
    'read-file',
    {
        title: 'æ–‡ä»¶è¯»å–å™¨',
        description: 'è¯»å–æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶å†…å®¹',
        inputSchema: {
            path: z.string().describe('æ–‡ä»¶è·¯å¾„'),
            encoding: z
                .enum(['utf8', 'base64'])
                .default('utf8')
                .describe('ç¼–ç æ ¼å¼'),
        },
        annotations: {
            readOnlyHint: true,
        },
    },
    async (args, extra) => {
        // è®°å½•å·¥å…·è°ƒç”¨å¼€å§‹
        await server.sendLoggingMessage({
            level: 'info',
            logger: 'FileManager',
            data: {
                message: 'å¼€å§‹è¯»å–æ–‡ä»¶',
                path: args.path,
                encoding: args.encoding,
                sessionId: extra.sessionId,
            },
        });

        try {
            const content = await fs.readFile(args.path, args.encoding);
            const stats = await fs.stat(args.path);

            // è®°å½•æˆåŠŸè¯»å–
            await server.sendLoggingMessage({
                level: 'info',
                logger: 'FileManager',
                data: {
                    message: 'æ–‡ä»¶è¯»å–æˆåŠŸ',
                    path: args.path,
                    size: stats.size,
                    encoding: args.encoding,
                },
            });

            return {
                content: [
                    {
                        type: 'text',
                        text: `# æ–‡ä»¶å†…å®¹: ${args.path}\n\n**å¤§å°**: ${stats.size} å­—èŠ‚`,
                    },
                ],
            };
        } catch (error) {
            // è®°å½•é”™è¯¯
            await server.sendLoggingMessage({
                level: 'error',
                logger: 'FileManager',
                data: {
                    message: 'æ–‡ä»¶è¯»å–å¤±è´¥',
                    path: args.path,
                    error: error.message,
                    stack: error.stack,
                },
            });

            return {
                content: [
                    {
                        type: 'text',
                        text: `âŒ æ— æ³•è¯»å–æ–‡ä»¶ ${args.path}: ${error.message}`,
                    },
                ],
                isError: true,
            };
        }
    }
);

// æ³¨å†Œé…ç½®æ–‡ä»¶èµ„æº
server.registerResource(
    'app-config',
    'file:///app/config.json',
    {
        title: 'åº”ç”¨é…ç½®',
        description: 'åº”ç”¨ç¨‹åºä¸»é…ç½®æ–‡ä»¶',
        mimeType: 'application/json',
    },
    async (uri, extra) => {
        // è®°å½•èµ„æºè®¿é—®
        await server.sendLoggingMessage({
            level: 'info',
            logger: 'ResourceManager',
            data: {
                message: 'è®¿é—®é…ç½®æ–‡ä»¶èµ„æº',
                uri,
                sessionId: extra.sessionId,
            },
        });

        try {
            const content = await fs.readFile('/app/config.json', 'utf8');

            // éªŒè¯JSONæ ¼å¼
            JSON.parse(content);

            return {
                contents: [
                    {
                        uri,
                        mimeType: 'application/json',
                        text: content,
                    },
                ],
            };
        } catch (error) {
            await server.sendLoggingMessage({
                level: 'error',
                logger: 'ResourceManager',
                data: {
                    message: 'é…ç½®æ–‡ä»¶è®¿é—®å¤±è´¥',
                    uri,
                    error: error.message,
                },
            });

            throw error;
        }
    }
);

// æ³¨å†Œä»£ç ç”Ÿæˆæç¤º
server.registerPrompt(
    'generate-function',
    {
        title: 'å‡½æ•°ä»£ç ç”Ÿæˆå™¨',
        description: 'æ ¹æ®æè¿°ç”ŸæˆæŒ‡å®šè¯­è¨€çš„å‡½æ•°ä»£ç ',
        arguments: {
            language: z.string().describe('ç¼–ç¨‹è¯­è¨€'),
            description: z.string().describe('å‡½æ•°åŠŸèƒ½æè¿°'),
            parameters: z.array(z.string()).optional().describe('å‡½æ•°å‚æ•°åˆ—è¡¨'),
            style: z
                .enum(['functional', 'object-oriented', 'procedural'])
                .optional()
                .describe('ç¼–ç¨‹é£æ ¼'),
        },
    },
    async (args, extra) => {
        const { language, description, parameters = [], style } = args;

        // è®°å½•æç¤ºä½¿ç”¨
        await server.sendLoggingMessage({
            level: 'info',
            logger: 'PromptManager',
            data: {
                message: 'ä»£ç ç”Ÿæˆæç¤ºè¢«è°ƒç”¨',
                language,
                description,
                parametersCount: parameters.length,
                style,
                sessionId: extra.sessionId,
            },
        });

        let systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„${language}ç¼–ç¨‹ä¸“å®¶ã€‚è¯·ç”Ÿæˆé«˜è´¨é‡ã€æœ‰æ³¨é‡Šçš„ä»£ç ã€‚`;

        if (style) {
            systemPrompt += `\nè¯·ä½¿ç”¨${
                style === 'functional'
                    ? 'å‡½æ•°å¼'
                    : style === 'object-oriented'
                    ? 'é¢å‘å¯¹è±¡'
                    : 'è¿‡ç¨‹å¼'
            }ç¼–ç¨‹é£æ ¼ã€‚`;
        }

        systemPrompt += `\n\nä»£ç è¦æ±‚ï¼š
- åŒ…å«è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
- éµå¾ª${language}æœ€ä½³å®è·µ
- åŒ…å«é”™è¯¯å¤„ç†ï¼ˆå¦‚é€‚ç”¨ï¼‰
- æä¾›ä½¿ç”¨ç¤ºä¾‹`;

        return {
            description: `ç”Ÿæˆ${language}å‡½æ•°ä»£ç `,
            messages: [
                {
                    role: 'system',
                    content: {
                        type: 'text',
                        text: systemPrompt,
                    },
                },
                {
                    role: 'user',
                    content: {
                        type: 'text',
                        text: `è¯·ç”Ÿæˆä¸€ä¸ª${language}å‡½æ•°ï¼ŒåŠŸèƒ½ï¼š${description}${
                            parameters.length
                                ? `\nå‚æ•°ï¼š${parameters.join(', ')}`
                                : ''
                        }${style ? `\nç¼–ç¨‹é£æ ¼ï¼š${style}` : ''}`,
                    },
                },
            ],
        };
    }
);

// å¯åŠ¨æœåŠ¡å™¨
async function main() {
    console.log('æ­£åœ¨å¯åŠ¨ MCP æ–‡ä»¶ç®¡ç†æœåŠ¡å™¨...');

    const transport = new StreamableHTTPServerTransport({
        sessionIdGenerator: () => crypto.randomUUID(),
    });

    try {
        // è¿æ¥åˆ°ä¼ è¾“å±‚
        await server.connect(transport);

        // å‘é€æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—
        await server.sendLoggingMessage({
            level: 'info',
            logger: 'ServerManager',
            data: {
                message: 'MCP æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ',
                serverName: 'file-manager-server',
                version: '1.0.0',
                timestamp: new Date().toISOString(),
            },
        });
        console.log(
            `å·¥å…·æ•°é‡: ${Object.keys(server._registeredTools || {}).length}`
        );
        console.log(
            `èµ„æºæ•°é‡: ${
                Object.keys(server._registeredResources || {}).length +
                Object.keys(server._registeredResourceTemplates || {}).length
            }`
        );
        console.log(
            `æç¤ºæ•°é‡: ${Object.keys(server._registeredPrompts || {}).length}`
        );

        // ä¼˜é›…å…³é—­å¤„ç†
        const gracefulShutdown = async (signal: string) => {
            console.log(`\nğŸ“¡ æ”¶åˆ° ${signal} ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­æœåŠ¡å™¨...`);

            try {
                // å‘é€å…³é—­æ—¥å¿—
                await server.sendLoggingMessage({
                    level: 'info',
                    logger: 'ServerManager',
                    data: {
                        message: 'æœåŠ¡å™¨å¼€å§‹å…³é—­',
                        signal,
                        uptime: process.uptime(),
                        timestamp: new Date().toISOString(),
                    },
                });

                // ç­‰å¾…æ—¥å¿—å‘é€å®Œæˆ
                await new Promise((resolve) => setTimeout(resolve, 100));

                // å…³é—­æœåŠ¡å™¨
                await server.close();
                console.log('âœ… æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­');
                process.exit(0);
            } catch (error) {
                console.error('âŒ å…³é—­è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error);
                process.exit(1);
            }
        };

        // æ³¨å†Œä¿¡å·å¤„ç†å™¨
        process.on('SIGINT', () => gracefulShutdown('SIGINT'));
        process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));

        // å¤„ç†æœªæ•è·çš„å¼‚å¸¸
        process.on('uncaughtException', async (error) => {
            console.error('âŒ æœªæ•è·çš„å¼‚å¸¸:', error);

            try {
                await server.sendLoggingMessage({
                    level: 'critical',
                    logger: 'ServerManager',
                    data: {
                        message: 'æœªæ•è·çš„å¼‚å¸¸',
                        error: error.message,
                        stack: error.stack,
                    },
                });
            } catch (logError) {
                console.error('æ—¥å¿—è®°å½•å¤±è´¥:', logError);
            }

            process.exit(1);
        });

        // å¤„ç†æœªå¤„ç†çš„ Promise æ‹’ç»
        process.on('unhandledRejection', async (reason, promise) => {
            console.error('âŒ æœªå¤„ç†çš„ Promise æ‹’ç»:', reason);

            try {
                await server.sendLoggingMessage({
                    level: 'error',
                    logger: 'ServerManager',
                    data: {
                        message: 'æœªå¤„ç†çš„ Promise æ‹’ç»',
                        reason: String(reason),
                        promise: String(promise),
                    },
                });
            } catch (logError) {
                console.error('æ—¥å¿—è®°å½•å¤±è´¥:', logError);
            }
        });
    } catch (error) {
        console.error('âŒ æœåŠ¡å™¨å¯åŠ¨å¤±è´¥:', error);

        try {
            await server.sendLoggingMessage({
                level: 'critical',
                logger: 'ServerManager',
                data: {
                    message: 'æœåŠ¡å™¨å¯åŠ¨å¤±è´¥',
                    error: error.message,
                    stack: error.stack,
                },
            });
        } catch (logError) {
            console.error('å¯åŠ¨å¤±è´¥æ—¥å¿—è®°å½•å¤±è´¥:', logError);
        }

        process.exit(1);
    }
}

// å¯åŠ¨åº”ç”¨
main().catch(console.error);
```
