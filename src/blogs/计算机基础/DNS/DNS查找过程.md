# DNS查找过程
## 什么是DNS
DNS是Domain Name System的缩写，翻译成中文就是“域名系统”。**用于实现域名和IP地址相互映射的一个分布式数据库。**

## 域名结构

域名的结构由标号序列组成，各标号之间用点隔开；如：

- ….三级域名.二级域名.顶级域名

各级域名由其上一级的域名管理机构管理，而最高级的顶级域名则由**ICANN**进行管理

<img src="https://gitee.com/CwdyBic/myBlog/raw/master/assets/http/dns/域名结构.png" />

## 域名服务器

DNS域名服务器也是按照层次划分的，每一个域名服务器都只对域名体系中的一部分进行管辖。根据域名服务器所起的作用，可以把域名服务器划分为四种不同的类型

- **根域名服务器：** 根域名服务器是最高层次的域名服务器，也是最重要的域名服务器。根域名服务器知道所有顶级域名服务器的域名和 IP地址。全球有13个根域名服务器名称。如果本地域名服务器无法对域名进行解析，就首先求助于根域名服务器。
- **顶级域名服务器：** 在DNS中，它们负责管理在该顶级域名服务器注册的下一级域名(二级域名)。所有顶级域名服务器的名称和IP地址是在根服务器注册的。当收到 DNS 查询请求时，就给出相应的回答（可能是最后的结果，也可能是下一步需要查询的域名服务器的 IP 地址）。
- **权威域名服务器：** 负责一个区的域名服务器。顶级域名服务器也可以算作是权威域名服务器，只不过由于其特殊性，我们专门把它划分为一类。因此权威域名服务器通常是指顶级域名以下的管理二级、三级、四级等域名的服务器。当一个权限域名服务器还不能给出最后的查询回答时，就会告知发出查询请求的DNS客户，下一步应当找哪一个权威域名服务器。

上面三种服务器的关系可以用这张图表示：

<img src="https://gitee.com/CwdyBic/myBlog/raw/master/assets/http/dns/DNS服务器关系.png" />

- **本地域名服务器：** 这类服务器不属于上面的层次结构，当一个主机(个人电脑)发出DNS请求时，查询请求就被发送到本地域名服务器，本地域名服务器负责回答这个查询，或者代替主机向域名空间中不同层次的权威域名服务器查询，再把查询的结果返回给主机。
    - 每个ISP(Internet Service Provider的缩写，即互联网服务提供商)都有一台本地DNS服务器，比如一个居民区的 ISP、一个大学的 ISP、一个机构的 ISP，都有一台或多台本地 DNS 服务器。


## DNS查询过程
<img height="500px" src="https://gitee.com/CwdyBic/myBlog/raw/master/assets/http/dns/域名查找方式.png" />

**（1）查看浏览器缓存**

当用户通过浏览器访问某域名时，浏览器首先会在自己的缓存中查找是否有该域名对应的 IP 地址。

**（2）查看操作系统缓存**

当浏览器缓存中无域名对应 IP 则会自动检查用户操作系统 Hosts 文件 DNS 缓存是否有该域名对应 IP。

**（3）查看路由器缓存**

当浏览器及系统缓存中均无域名对应 IP 则进入路由器缓存中检查，**以上三步均为客服端的 DNS 缓存。**

**（4）查看本地域名服务器（ISP DNS）缓存**

当在用户客服端查找不到域名对应 IP 地址，则将进入 ISP DNS 缓存中进行查询。比如你用的是电信的网络，则会进入电信的 DNS 缓存服务器中进行查找。**（注意：主机和本地域名服务器之间的查询方式是 递归查询 ）**

**（5）询问根域名服务器**

当以上均未完成，则进入根服务器进行查询。全球仅有 13 台根域名服务器，1 个主根域名服务器，其余 12 为辅根域名服务器。根域名收到请求后会查看区域文件记录，若没有记录，则将其管辖范围内顶级域名（如.com、.cn等）服务器 IP 告诉本地 DNS 服务器。**（注意：本地域名服务器和其他域名服务器之间的查询方式是迭代查询，防止根域名服务器压力过大）。**

**（6）询问顶级域名服务器**

顶级域名服务器收到请求后查看区域文件记录，若无记录则将其管辖范围内权威域名服务器的 IP 地址告诉本地 DNS 服务器。

**（7）询问权威域名（主域名）服务器**

权威域名服务器接收到请求后查询自己的缓存，如果没有则进入下一级域名服务器进行查找，并重复该步骤直至找到正确记录。

**（8）保存结果至缓存**

1. 本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址 缓存 起来
2. 操作系统 将 IP 地址返回给浏览器，同时自己也将 IP 地址 缓存 起来
3. 至此，浏览器就得到了域名对应的 IP 地址，并将 IP 地址 缓存 起来

### DNS查询算法

DNS 查询有两种方式：**递归查询** 和 **迭代查询** 。

#### 递归查询
一般来说，DNS 客户端设置使用的 DNS 服务器一般都是 **递归查询** ，它负责全权处理客户端的 DNS 查询请求，直到返回最终结果

<img height="400px" src="https://gitee.com/CwdyBic/myBlog/raw/master/assets/http/dns/dns递归查找.png" />

#### 迭代查询
而 DNS 根域名服务器之间一般采用 **迭代查询** 方式，以免根域名服务器的压力过大；这些远程查询都是基于UDP协议，通常使用 53 号端口。

<img height="400px" src="https://gitee.com/CwdyBic/myBlog/raw/master/assets/http/dns/dns迭代查找.png" />


### 为什么选择基于 UDP 协议发起 DNS 查询，而不是 TCP？

衡量计算机通信快慢的指标是 **响应时间** ，即从用户发出通信指令（输入网址敲回车键）开始，到用户看到完整页面为止，所花费的时间。即：

**响应时间 = DNS域名解析时间 + TCP 连接建立时间 + HTTP交易时间**

其中，TCP 连接建立需要三次挥手，HTTP交易一来一回，都不可能减少，所以只能让DNS域名解析的时间越小越好

#### TCP

如果 DNS 查询继续采用 TCP 连接？TCP 作为可靠的传输协议，TCP 建立连接会带来以下的额外开销：

- TCP 建立连接需要进行三次网络通信；
- TCP 建立连接需要传输 ~130 字节的数据；
- TCP 销毁连接需要进行四次网络通信；
- TCP 销毁连接需要传输 ~160 字节的数据；

假设网络通信所消耗的时间是可以忽略的不计的，如果我们只考虑 TCP 建立连接时传输的数据的话，可以简单来算一笔账：

使用 TCP 协议（共 330 字节）:

- 三次握手 — 14x3(Ethernet) + 20x3(IP) + 44 + 44 + 32 字节
- 查询协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节
- 响应协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节

需要注意的是，我们在这里计算结果的前提是 DNS 解析器**只需要与一个命名服务器或者权威服务器进行通信**就可以获得 DNS 响应，但是在实际场景中，DNS 解析器可能会递归地与多个命名服务器进行通信，这也加倍地放大了 TCP 协议在额外开销上的劣势。

#### UDP

如果使用 UDP 协议（共 84 字节）

- 查询协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节
- 响应协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节

如果 DNS 查询的请求体和响应分别是 15 和 70 字节，那么 TCP 相比于 UDP 协议会增加 ~250 字节和 ~145% 的额外开销

所以当请求体和响应的大小比较小时，通过 TCP 协议进行传输不仅需要传输更多的数据，还会消耗更多的资源，多次通信以及信息传输带来的时间成本在 DNS 查询较小时是无法被忽视的，TCP 连接带来的可靠性在 DNS 的场景中没能发挥太大的作用。

##### UDP 传输的弱点

由于历史的原因，互联网上物理链路的最小 MTU = 576 ，基于 UDP 传输的 DNS 为了限制报文不超过 576 ，所以将 DNS 报文限制在 512 字节。

这样一旦 DNS 查询应答超过 512 字节，基于 UDP 的 DNS 就只有截短为 512 字节，那么用户得到的 DNS 应答就是不完整的。

为了克服这种困难，在 DNS 协议中明确了 **『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』** 这一规范。尽管交易时间可能比较长，但毕竟可以得到完整的答案，总比得到不完整的答案要好。

同时，当数据包足够大的时候，TCP 三次握手带来的额外开销比例就会越来越小，与整个包的大小相比就会趋近于 0

RFC6891 中引入了 EDNS 机制，它允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的传输数据分片以及丢失（在实际生产中，一旦数据包中的数据超过了传送链路的最大传输单元MTU，当前数据包就可能会被分片传输、丢弃），使得这一特性不够可靠；

#### 总结

需要注意的是，DNS 使用了 UDP 协议来获取域名对应的 IP 地址，这个没错，但有些片面，准确的来说，DNS **查询**在刚设计时主要使用 **UDP** 协议进行通信，而 TCP 协议也是在 DNS 的演进和发展中被加入到规范的：

1. DNS 在设计之初就在区域 **传输中引入了 TCP 协议** ， **在查询中使用 UDP 协议** ，它同时占用了 UDP 和 TCP 的 **53** 端口
2. 当 DNS 超过了 **512** 字节的限制，在 DNS 协议中明确了 **『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』** 这一规范；
3. 随后引入的 EDNS 机制允许使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的数据分片以及丢失，使得这一特性不够可靠；
4. 在最近的几年，重新规定了 DNS 应该同时支持 UDP 和 TCP 协议，TCP 协议也不再只是重试时的选择。